<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>L·ªäCH C·ªêNG HI·∫æN HGS - Xanh nh·∫°t</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background: #eef4fb; color: #1f2937; }
    .card { background: #ffffff; border-radius: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .toast {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(59,130,246,0.95); color: white; padding: 10px 18px;
      border-radius: 10px; font-weight: 600; z-index: 9999; animation: fadeInOut 2s forwards;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translate(-50%, -55%); }
      10%, 90% { opacity: 1; transform: translate(-50%, -50%); }
      100% { opacity: 0; transform: translate(-50%, -45%); }
    }
    #suggestions { z-index: 50; }
    table.result-table th, table.result-table td {
      padding: 8px 6px; border-bottom: 1px solid #e5e7eb; font-size: 13px; text-align:left; vertical-align: middle;
    }
    table.result-table td.center { text-align:center; }
    .day-container { background: white; border: 1px solid #dbeafe; border-radius: 10px; padding: 10px 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); }
    .day-title { font-weight: 700; font-size: 15px; padding: 4px 0; color: #2563eb; }
    .day-past { opacity: 0.6; background: #f8fafc; }
    .day-today { border: 2px solid #3b82f6; box-shadow: 0 0 10px rgba(59,130,246,0.15); }
    .btn-main { background: #3b82f6; color: white; border-radius: 8px; padding: 10px 0; font-weight: 600; width: 100%; }
    .btn-main:hover { background: #2563eb; }
    .btn-danger { background: #ef4444; color: white; border-radius: 8px; padding: 10px 0; font-weight: 600; width: 100%; }
    .btn-yellow { background: #facc15; color: #1f2937; border-radius: 8px; padding: 10px 0; font-weight: 600; width: 100%; }
    
    .checkbox-wrapper { display: flex; align-items: center; gap: 6px; cursor: pointer; user-select: none; }
    .checkbox-wrapper input { width: 16px; height: 16px; }
  </style>
</head>

<body class="p-3">
  <div class="max-w-lg mx-auto card p-4 space-y-4">
    <div class="text-center">
      <h1 class="text-xl font-bold text-blue-600">üìÖ L·ªäCH "C·ªêNG HI·∫æN" HGS</h1>
      <p class="text-sm text-gray-500 mt-1">
        Nh·∫≠p ca nh∆∞: S; X; A; HC; 1X; 1-X; X1; X-1; 0.5X-1; H; DH; M...
      </p>
    </div>

    <div class="space-y-2">
      <input id="week-name" type="text" placeholder="T√™n tu·∫ßn (VD: Tu·∫ßn 44 - Th√°ng 10)"
             class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400">
      <div class="flex gap-2 flex-wrap">
        <button id="save-week" class="flex-1 btn-main">üíæ L∆∞u tu·∫ßn</button>
        <select id="week-select" class="flex-1 border border-gray-300 rounded-lg text-sm px-2 py-2">
          <option value="">Ch·ªçn tu·∫ßn</option>
        </select>
      </div>

      <div class="space-y-2">
        <input type="file" id="excel-upload" accept=".xls,.xlsx"
               class="w-full border border-gray-300 rounded-lg text-sm px-3 py-2">
        <p class="text-xs text-gray-500 mt-1">
          (ƒê·ªÉ xem l·ªãch v√† chuy·∫øn bay c·ªßa t·∫•t c·∫£ m·ªçi ng∆∞·ªùi, h√£y t·∫£i file Excel v√† upload l√™n web, c√°ch t·∫£i file Excel t·∫°i <a href="https://www.thegioididong.com/tin-tuc/cach-tai-file-google-sheets-ve-dien-thoai-1417179?gidzl=FVum457VWrqou3WJKCA0M3BaFnT8m84AA-Cx5qx1W5akucaO7CU117lcEanEmeK1V-Dh6sPK4OfvMDQAK0" target="_blank" class="text-red-500 underline font-medium">ƒë√¢y</a>)
        </p>
        <select id="employee-select"
                class="w-full border border-gray-300 rounded-lg text-sm px-3 py-2">
          <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
        </select>
      </div>
    </div>

    <div id="days-container" class="space-y-3"></div>

    <div class="grid grid-cols-1 gap-2">
      <button id="calc-week" class="btn-main">üìÖ T√≠nh l·ªãch tu·∫ßn</button>
      <button id="clear-week" class="btn-yellow">üßπ X√≥a tu·∫ßn n√†y</button>
      <button id="clear-all" class="btn-danger">üóë X√≥a t·∫•t c·∫£</button>
    </div>

    <div id="result-container" class="hidden">
      <div class="overflow-x-auto mt-3 rounded-lg border border-gray-200">
        <table class="w-full text-sm text-gray-700">
          <thead class="bg-blue-100">
            <tr>
              <th class="px-2 py-1 text-left">Th·ª©</th>
              <th class="px-2 py-1 text-left">Ca</th>
              <th class="px-2 py-1 text-center">Gi·ªù v√†o</th>
              <th class="px-2 py-1 text-center">Gi·ªù ra</th>
              <th class="px-2 py-1 text-center">T·ªïng</th>
            </tr>
          </thead>
          <tbody id="result-body"></tbody>
        </table>
      </div>
      <p id="tribute" class="text-center font-bold text-blue-600 mt-2 hidden">
        üí™ B·∫†N ƒê√É C·ªêNG HI·∫æN H·∫æT M√åNH C·∫¢ TU·∫¶N!
      </p>
    </div>

    <a href="https://www.facebook.com/huy.hai.333030" target="_blank"
      class="text-center mt-3 font-semibold text-blue-600 text-sm bg-blue-50 py-2 rounded-lg shadow-sm block no-underline">
      ‚ú® Created by H·∫£i 9 ‚ú®
    </a>

    <div class="border-t pt-4 mt-4">
      <h2 class="text-lg font-semibold text-blue-600 text-center mb-2">
        üîç Tra c·ª©u chuy·∫øn bay
      </h2>
      <p class="text-xs text-center text-red-500 mb-2 italic">
        "Link n√†y ch·ªâ c√≥ m·ª•c ƒë√≠ch tham kh·∫£o, File c√°n b·ªô g·ª≠i v·∫´n lu√¥n l√† chu·∫©n nh·∫•t"
      </p>
      <div class="space-y-2">
        <input id="search-name" type="text" placeholder="Nh·∫≠p t√™n nh√¢n vi√™n (VD: H·∫¢I 9 ho·∫∑c Hai 9)"
               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-base focus:ring-2 focus:ring-blue-400"
               autocomplete="off">
        <div id="suggestions"
             class="bg-white border border-gray-200 rounded-lg shadow hidden max-h-40 overflow-y-auto"></div>
        <div id="flight-result" class="mt-3 text-sm"></div>
      </div>
    </div>

    <div class="border-t-2 border-blue-100 pt-5 mt-6 bg-white rounded-xl p-3 shadow-sm">
      <h2 class="text-lg font-bold text-green-600 text-center mb-1">
        ü§ù L√ÄM H·ªò (Ch·ªâ m·ªõi code cho K36)
      </h2>
      <p class="text-xs text-center text-gray-500 mb-3">
        T√¨m ng∆∞·ªùi r·∫£nh (kh√¥ng v∆∞·ªõng ca) trong kho·∫£ng gi·ªù b·∫°n nh·∫≠p
      </p>
      
      <div class="space-y-3">
        <div class="flex gap-2">
            <div class="w-1/3">
                <label class="block text-xs font-semibold mb-1">T·ª´ gi·ªù</label>
                <input id="help-from" type="number" step="0.5" placeholder="11" 
                       class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm">
            </div>
            <div class="w-1/3">
                <label class="block text-xs font-semibold mb-1">ƒê·∫øn gi·ªù</label>
                <input id="help-to" type="number" step="0.5" placeholder="18.5" 
                       class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm">
            </div>
            <div class="w-1/3">
                <label class="block text-xs font-semibold mb-1">Th·ª©</label>
                <select id="help-day" class="w-full border border-gray-300 rounded px-2 py-1.5 text-sm">
                    <option value="mon">Th·ª© Hai</option>
                    <option value="tue">Th·ª© Ba</option>
                    <option value="wed">Th·ª© T∆∞</option>
                    <option value="thu">Th·ª© NƒÉm</option>
                    <option value="fri">Th·ª© S√°u</option>
                    <option value="sat">Th·ª© B·∫£y</option>
                    <option value="sun">Ch·ªß Nh·∫≠t</option>
                </select>
            </div>
        </div>

        <div class="flex justify-center gap-6 py-1">
            <label class="checkbox-wrapper">
                <input type="checkbox" id="chk-7c" checked>
                <span class="text-sm font-medium">Team 7C</span>
            </label>
            <label class="checkbox-wrapper">
                <input type="checkbox" id="chk-pr" checked>
                <span class="text-sm font-medium">Team PR</span>
            </label>
        </div>

        <button id="btn-find-help" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg shadow">
            üîç T√¨m ng∆∞·ªùi r·∫£nh
        </button>

        <div id="help-result" class="hidden mt-3 bg-green-50 p-3 rounded-lg border border-green-200">
            <p class="font-bold text-green-700 text-sm mb-2 border-b border-green-200 pb-1">K·∫æT QU·∫¢:</p>
            <ul id="help-list" class="list-disc list-inside text-sm text-gray-700 space-y-1"></ul>
        </div>
      </div>
    </div>
    </div>

  <div id="toast"></div>
<script>
/* ======== KH·ªûI T·∫†O INPUT CHO C√ÅC TH·ª® (Kh√¥ng ƒë·ªïi) ======== */
document.addEventListener("DOMContentLoaded", () => {
  const days = ["Th·ª© Hai","Th·ª© Ba","Th·ª© T∆∞","Th·ª© NƒÉm","Th·ª© S√°u","Th·ª© B·∫£y","Ch·ªß Nh·∫≠t"];
  const box = document.getElementById("days-container");
  box.innerHTML = "";
  days.forEach((d,i)=>{
    const wrapper = document.createElement('div');
    wrapper.innerHTML = `
      <label class="block text-sm font-semibold text-gray-700 mb-1">${d}</label>
      <input id="day${i}" type="text" placeholder="VD: S; X; A; HC; 1X; X-1"
      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400">
    `;
    box.appendChild(wrapper);
  });
});
</script>

<script>
/* ================= JAVASCRIPT CH√çNH ================= */
const c = id => document.getElementById(id);
const days = ["Th·ª© Hai","Th·ª© Ba","Th·ª© T∆∞","Th·ª© NƒÉm","Th·ª© S√°u","Th·ª© B·∫£y","Ch·ªß Nh·∫≠t"];
const daysOrder = ["MON","TUE","WED","THU","FRI","SAT","SUN"];
const EXCEL_STORAGE_KEY = 'hgs_last_excel_data_v3';
const SEARCH_STORAGE_KEY = 'hgs_last_search_name_v3';

let employeeData = [];
let flightData = [];

const showToast = msg => {
  const t = document.createElement('div');
  t.className='toast';
  t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),2000);
};

/* --------- CHU·∫®N H√ìA CHU·ªñI (Kh√¥ng ƒë·ªïi) ---------- */
function removeDiacritics(str){
  if(!str) return "";
  const s = str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  return s.replace(/ƒë/g,'d').replace(/ƒê/g,'D');
}
function normalizeText(s){
  if(!s) return "";
  return removeDiacritics(s)
    .replace(/[‚Äì‚Äî]/g,'-')
    .replace(/\u00A0/g,' ')
    .replace(/[^A-Z0-9\s\-]/gi,'')
    .trim()
    .replace(/\s+/g,' ')
    .toUpperCase();
}

/* ---------- L∆ØU/T·∫¢I TU·∫¶N (Kh√¥ng ƒë·ªïi) ---------- */
function createInputs(){
  const box = c("days-container");
  box.innerHTML = "";
  days.forEach((d,i)=>{
    const wrapper = document.createElement('div');
    wrapper.innerHTML = `
      <label class="block text-sm font-semibold text-gray-700 mb-1">${d}</label>
      <input id="day${i}" type="text" placeholder="VD: S; X; A; HC; 1X; X-1"
      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400">
    `;
    box.appendChild(wrapper);
  });
}
const keyWeek = n => "week_"+n;
const loadWeeksList = ()=>JSON.parse(localStorage.getItem("weeks_list")||"[]");
const saveWeeksList = arr=>localStorage.setItem("weeks_list", JSON.stringify(arr));

function saveWeek(){
  const n = c("week-name").value.trim();
  if(!n){ showToast("Nh·∫≠p t√™n tu·∫ßn"); return; }
  const data = {};
  days.forEach((_,i)=> data["day"+i]=c("day"+i).value.trim());
  localStorage.setItem(keyWeek(n), JSON.stringify(data));
  let list = loadWeeksList();
  if(!list.includes(n)){ list.push(n); saveWeeksList(list); fillWeekSelect(); }
  showToast("ƒê√£ l∆∞u tu·∫ßn "+n);
}
function fillWeekSelect(){
  const s = c("week-select"); if(!s) return;
  const list = loadWeeksList();
  s.innerHTML='<option value="">Ch·ªçn tu·∫ßn</option>';
  list.forEach(n=>{
    const o=document.createElement('option');
    o.value=n; o.textContent=n; s.appendChild(o);
  });
}
function loadWeek(n){
  const raw = localStorage.getItem(keyWeek(n));
  if(!raw){ showToast("Tu·∫ßn tr·ªëng"); return; }
  const d = JSON.parse(raw);
  days.forEach((_,i)=> c("day"+i).value = d["day"+i]||"");
  showToast("ƒê√£ t·∫£i "+n);
}
function deleteWeek(){
  const n=c("week-name").value.trim();
  if(!n) return showToast("Nh·∫≠p t√™n tu·∫ßn");
  localStorage.removeItem(keyWeek(n));
  let list = loadWeeksList().filter(x=>x!==n);
  saveWeeksList(list); fillWeekSelect();
  days.forEach((_,i)=> c("day"+i).value="");
  showToast("ƒê√£ x√≥a tu·∫ßn "+n);
}
function clearAll(){
  if(!confirm("X√≥a t·∫•t c·∫£ tu·∫ßn?")) return;
  loadWeeksList().forEach(n=>localStorage.removeItem(keyWeek(n)));
  saveWeeksList([]); fillWeekSelect();
  days.forEach((_,i)=> c("day"+i).value="");
  showToast("ƒê√£ x√≥a t·∫•t c·∫£");
}

/* ---------- T√çNH CA (Kh√¥ng ƒë·ªïi) ---------- */
const shifts={
  HC:{start:7.5,end:15.5},A:{start:22,end:30},X:{start:14,end:22},S:{start:6,end:14}
};
function parseShift(str){
  str=(str||"").toUpperCase().trim();
  if(!str) return null;
  if(str==="OM"||str==="OFF") return {start:0,end:0,dur:0}; 

  const re_fixed=/^(\d*\.?\d*-?)?(H|DH|M)(\d*\.?\d*)?(-?\d*\.?\d*)?$/; 
  const m_fixed=re_fixed.exec(str);
  if(m_fixed){
      const [,pre,code,val,suf]=m_fixed;
      let duration=8, start=8; 
      
      if(code==="DH"||code==="M"){
          duration=parseFloat(val)||0;
      } else if (code==="H"){
          if(val){duration=parseFloat(val);}
          if(/H4S/.test(str)) { start=8; duration=4; } 
          else if(/H4C/.test(str)) { start=14; duration=4; }
      }
      
      if(duration<=0) return {start:0,end:0,dur:0};
      
      let end=start+duration;
      if(pre){ const v=parseFloat(pre.replace("-","")); pre.includes("-")?start+=v:start-=v; }
      if(suf){ const v=parseFloat(suf.replace("-","")); suf.startsWith("-")?end-=v:end+=v; }

      if(start>=end) end+=24;
      return {start,end,dur:end-start};
  }
  
  const re=/^(\d*\.?\d*-?)?([A-Z]{1,2})(-?\d*\.?\d*)?$/;
  const m=re.exec(str);
  if(!m) return {error:"Sai ƒë·ªãnh d·∫°ng"};
  const [,pre,code,suf]=m;
  if(!shifts[code]) return {error:"Ca kh√¥ng t·ªìn t·∫°i"};
  let {start,end}=shifts[code];
  if(pre){ const val=parseFloat(pre.replace("-","")); pre.includes("-")?start+=val:start-=val; }
  if(suf){ const val=parseFloat(suf.replace("-","")); suf.startsWith("-")?end-=val:end+=val; }
  if(start>=end) end+=24;
  return {start,end,dur:end-start};
}
function fmtHoursToHHMM(t){
  const hh=Math.floor(t%24);
  const mm=Math.round((t%1)*60);
  return String(hh).padStart(2,"0")+":"+String(mm).padStart(2,"0");
}
function calcWeek(){
  const tbody=c("result-body"); if(!tbody) return;
  tbody.innerHTML=""; let total=0,full=true;
  days.forEach((d,i)=>{
    const v=c("day"+i).value.trim();
    if(!v){ tbody.innerHTML+=`<tr><td>${d}</td><td colspan=4 class="italic text-gray-400">Ngh·ªâ</td></tr>`; full=false; return; }
    let sum=0; const parts=v.split(";").map(x=>x.trim()).filter(Boolean);
    parts.forEach((p,j)=>{
      const r=parseShift(p);
      if(r&&r.error){tbody.innerHTML+=`<tr><td>${j?"":d}</td><td>${p}</td><td colspan=3 class="text-red-600">${r.error}</td></tr>`;return;}
      if(r){
          if(r.dur===0 && (p==="OM"||p==="OFF")){
              tbody.innerHTML+=`<tr><td>${j?"":d}</td><td>${p}</td><td colspan=3 class="italic text-gray-400">${p==="OM"?"Ngh·ªâ ·ªëm":"Ngh·ªâ OFF"}</td></tr>`;
          } else if(r.dur>0){
              tbody.innerHTML+=`<tr><td>${j?"":d}</td><td>${p}</td><td>${fmtHoursToHHMM(r.start)}</td><td>${fmtHoursToHHMM(r.end)}</td><td>${r.dur.toFixed(1)}h</td></tr>`;
              sum+=r.dur;
          }
      }
    });
    if(parts.length>1) tbody.innerHTML+=`<tr class="bg-blue-50 font-medium"><td></td><td colspan=3>T·ªïng ng√†y</td><td>${sum.toFixed(1)}h</td></td></tr>`;
    total+=sum;
  });
  tbody.innerHTML+=`<tr class="bg-blue-100 font-bold"><td colspan=4>T·ªïng tu·∫ßn</td><td>${total.toFixed(1)}h</td></tr>`;
  c("result-container").classList.remove("hidden");
  c("tribute").classList.toggle("hidden",!full);
  showToast("ƒê√£ t√≠nh xong!");
}

/* ---------- EXCEL PARSE (Kh√¥ng ƒë·ªïi) ---------- */
function combine(a,b){
  const v1=(a||"").toString().trim();
  const v2=(b||"").toString().trim();
  let combined=[v1,v2].filter(Boolean).join(";");
  if(!combined||combined.toUpperCase().includes("OFF")) combined="";
  return combined;
}

function parseSheet(sheet,name){
  const rows=XLSX.utils.sheet_to_json(sheet,{header:1});
  if(rows.length<2) return [];
  return rows.slice(1).map(row=>({
    name:(row[1]||"").toString().trim(),
    mon:combine(row[2],row[4]),
    tue:combine(row[5],row[7]),
    wed:combine(row[8],row[10]),
    thu:combine(row[11],row[13]),
    fri:combine(row[14],row[16]),
    sat:combine(row[17],row[19]),
    sun:combine(row[20],row[22]),
    source:name
  })).filter(e=>e.name);
}

function excelTimeToHHMM(v){
  if(v===undefined||v===null) return "";
  if(typeof v==='string') return v.trim();
  if(typeof v==='number'){
    const frac=v-Math.floor(v);
    const totalMinutes=Math.round(frac*24*60);
    const H=Math.floor(totalMinutes/60);
    const M=totalMinutes%60;
    return String(H).padStart(2,'0')+':'+String(M).padStart(2,'0');
  }
  return String(v);
}

/* --- parseFlightSheet (ƒê√£ c·∫≠p nh·∫≠t c·ªôt v√† h√†ng) --- */
function parseFlightSheet(sheet,sheetName){
  const out=[];
  const startRow=4,endRow=46;
  
  const fltCol='M'; const etdCol='N'; const gateCol='Q'; 
  
  const startCol=XLSX.utils.decode_col('P');
  const endCol=XLSX.utils.decode_col('AF');

  let lastFlt="",lastEtd="",lastGate="";
  
  const namePattern = /([\p{L}ƒêƒë\s\-]+?)\s+(\d{1,4})/ug;

  for(let r=startRow;r<=endRow;r++){
    const fltCell=sheet[fltCol+r];
    const etdCell=sheet[etdCol+r];
    const gateCell=sheet[gateCol+r];

    const fltValRaw=fltCell?(fltCell.v||'').toString().trim():'';
    const etdValRaw=etdCell?etdCell.v:'';
    const gateValRaw=gateCell?(gateCell.v||'').toString().trim():'';
    const fltVal=fltValRaw||lastFlt;
    const etdVal=etdValRaw!==undefined&&etdValRaw!==""?excelTimeToHHMM(etdValRaw):lastEtd;
    const gateVal=gateValRaw||lastGate;
    if(fltVal){lastFlt=fltVal;lastEtd=etdVal;lastGate=gateVal;}
    if(!fltVal) continue;

    for(let c=startCol;c<=endCol;c++){
      const colLetter=XLSX.utils.encode_col(c);
      const cell=sheet[colLetter+r];
      if(!cell||!cell.v) continue;
      let raw=String(cell.v).trim();
      if(!raw) continue;
      
      const taskGroups = raw.split(/[;\n]+/).map(x=>x.trim()).filter(Boolean);
      
      const isSup=colLetter==='P',isGate=colLetter==='Q',
            isKetso=colLetter==='R',isWlct=colLetter==='S';

      taskGroups.forEach(groupStr => {
        const upperGroup = groupStr.toUpperCase();
        let tag = "";
        const hasBD = /\b(BRD|BD)\b/.test(upperGroup);
        const hasKO = /\b(KO|K)\s*(BRD|BD)\b/.test(upperGroup);
        if (hasKO) tag = "NO";
        else if (hasBD) tag = "BRD";

        const notes = [];
        if(/\bK[E√ä]M\s*QU·∫¶Y\b/.test(upperGroup)) notes.push("K√àM QU·∫¶Y");

        const matches = [...groupStr.matchAll(namePattern)];
        matches.forEach(m => {
          const nameOnly = `${m[1].trim()} ${m[2].trim()}`.toUpperCase();
          const normalizedName = normalizeText(nameOnly);
          out.push({
            sheet:sheetName,row:r,col:colLetter,tokenRaw:groupStr,
            nameOnly:nameOnly,nameNormalized:normalizedName,
            tag:tag,
            notes:notes,
            flt:fltVal,etd:etdVal,gate:gateVal,
            supFlag:isSup,gateFlag:isGate,ketsoFlag:isKetso,wlctFlag:isWlct,
            uniqueKey:`${sheetName}-${fltVal}-${etdVal}-${gateVal}-${normalizedName}-${colLetter}-${r}`
          });
        });
      });
    }
  }
  return out;
}

/* --- ƒê·ªçc file Excel & g·ªôp d·ªØ li·ªáu (Kh√¥ng ƒë·ªïi) --- */
function processExcelData(data){
  const wb=XLSX.read(data,{type:"array"});
  const target=["b·∫£ng ch·∫•m c√¥ng qt","b·∫£ng ch·∫•m c√¥ng nƒë"];
  let allEmp=[];
  target.forEach(t=>{
    const sn=wb.SheetNames.find(n=>n.trim().toLowerCase()===t);
    if(sn){const s=wb.Sheets[sn];allEmp=allEmp.concat(parseSheet(s,sn));}
  });
  employeeData=allEmp;
  const sel=c("employee-select");
  sel.innerHTML='<option value="">-- Ch·ªçn nh√¢n vi√™n --</option>';
  employeeData.sort((a,b)=>a.name.localeCompare(b.name,"vi",{sensitivity:"base"}))
    .forEach(e=>{
      const o=document.createElement('option');
      o.value=e.name;o.textContent=e.name+" ("+e.source.toUpperCase().replace("B·∫¢NG CH·∫§M C√îNG ","")+")";
      sel.appendChild(o);
    });
  flightData=[];
  daysOrder.forEach(d=>{
    const sn=wb.SheetNames.find(n=>n.trim().toUpperCase()===d);
    if(sn){const s=wb.Sheets[sn];flightData=flightData.concat(parseFlightSheet(s,d));}
  });
  return true;
}

/* --- File Upload (Kh√¥ng ƒë·ªïi) --- */
c("excel-upload").addEventListener("change",e=>{
  const f=e.target.files[0];if(!f) return;
  const r=new FileReader();
  r.onload=evt=>{
    const data=new Uint8Array(evt.target.result);
    const binary=data.reduce((a,i)=>a+String.fromCharCode(i),"");
    const base64=btoa(binary);
    localStorage.setItem(EXCEL_STORAGE_KEY,base64);
    processExcelData(data);
    showToast("‚úÖ ƒê√£ t·∫£i file Excel");
  };
  r.readAsArrayBuffer(f);
});

/* --- T·∫£i l·∫°i file l∆∞u (Kh√¥ng ƒë·ªïi) --- */
function loadLastExcelData(){
  const base64=localStorage.getItem(EXCEL_STORAGE_KEY);
  if(!base64) return false;
  try{
    const binary=atob(base64);
    const arr=new Uint8Array(binary.length);
    for(let i=0;i<binary.length;i++) arr[i]=binary.charCodeAt(i);
    processExcelData(arr);
    showToast("ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ b·ªô nh·ªõ");
    return true;
  }catch(e){console.error(e);localStorage.removeItem(EXCEL_STORAGE_KEY);return false;}
}

/* --- employee-select (Kh√¥ng ƒë·ªïi) --- */
c("employee-select").addEventListener("change",e=>{
  const name=e.target.value;if(!name) return;
  const emp=employeeData.find(x=>x.name.trim().toLowerCase()===name.trim().toLowerCase());
  if(!emp) return showToast("Kh√¥ng t√¨m th·∫•y!");
  ["mon","tue","wed","thu","fri","sat","sun"].forEach((d,i)=>c("day"+i).value=emp[d]||"");
  showToast("ƒê√£ t·∫£i l·ªãch c·ªßa "+name);

  c("search-name").value = name;
  localStorage.setItem(SEARCH_STORAGE_KEY, name);
  setTimeout(()=>renderFlightResults(name), 120);
});

/* === Matching helpers (ƒê√É C·∫¨P NH·∫¨T: Chia th√†nh 2 lo·∫°i match) === */

// Helper: T√°ch chu·ªói th√†nh token (VD: "HAI 9" -> ["HAI", "9"])
function tokenizeForMatch(normStr){
  if(!normStr) return [];
  return normStr.split(/[\s\-]+/).map(s=>s.trim()).filter(Boolean);
}

// F_1: Exact String Match (Ch·ªâ t√¨m t√™n ch√≠nh x√°c, d√πng cho K·∫æT QU·∫¢ CU·ªêI v√† L√ÄM H·ªò)
function exactNameMatches(searchNorm, tokenNorm){
  return searchNorm === tokenNorm;
}

// F_2: Partial Token Match (D√πng cho G·ª¢I √ù T√åM KI·∫æM, cho ph√©p t√¨m ki·∫øm m·ªôt ph·∫ßn token)
function partialNameMatches(searchNorm, tokenNorm){
  if(!searchNorm || !tokenNorm) return false;
  const sTokens = tokenizeForMatch(searchNorm);
  const tTokens = tokenizeForMatch(tokenNorm);
  if(sTokens.length===0) return false;
  // Ki·ªÉm tra t·∫•t c·∫£ token trong chu·ªói t√¨m ki·∫øm (sTokens) ph·∫£i c√≥ m·∫∑t trong chu·ªói ƒë√≠ch (tTokens)
  return sTokens.every(st=>{
    return tTokens.some(tt => tt === st);
  });
}

/* --- SEARCH (ƒê√É C·∫¨P NH·∫¨T: D√πng partialNameMatches) --- */
function renderSuggestions(q){
  const box=c("suggestions");
  if(!q||!flightData.length){box.classList.add("hidden");return;}
  const qNorm=normalizeText(q);
  const map=new Map();
  flightData.forEach(d=>{
    if(d.nameNormalized && !map.has(d.nameNormalized)) map.set(d.nameNormalized, d.nameOnly);
  });
  // S·ª≠ d·ª•ng partialNameMatches cho G·ª¢I √ù
  const matches=[...map.entries()].filter(([norm])=>{
    return partialNameMatches(qNorm, norm);
  }).map(([norm,disp])=>({norm,disp}));
  if(!matches.length){box.classList.add("hidden");return;}
  box.innerHTML=matches.map(m=>`<div class="px-3 py-2 hover:bg-blue-50 cursor-pointer" data-n="${m.norm}">${m.disp}</div>`).join("");
  box.classList.remove("hidden");
  box.querySelectorAll("div").forEach(div=>{
    div.onclick=()=>{
      const val=div.textContent;
      c("search-name").value=val;
      box.classList.add("hidden");
      localStorage.setItem(SEARCH_STORAGE_KEY, val);
      renderFlightResults(val);
    };
  });
}

/* --- renderFlightResults (ƒê√É C·∫¨P NH·∫¨T: D√πng exactNameMatches) --- */
function renderFlightResults(nameRaw){
  const container=c("flight-result");
  if(!flightData.length){
    container.innerHTML=`<p class="text-center text-gray-500 italic">Ch∆∞a c√≥ d·ªØ li·ªáu. H√£y t·∫£i file Excel.</p>`;return;
  }
  const qNorm=normalizeText(nameRaw);
  // S·ª≠ d·ª•ng exactNameMatches cho K·∫æT QU·∫¢ CU·ªêI
  let matches=flightData.filter(d=>exactNameMatches(qNorm, d.nameNormalized));
  if(!matches.length){container.innerHTML=`<p class="text-center text-gray-500 italic">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho "${nameRaw}"</p>`;return;}
  const unique=new Map();
  matches.forEach(m=>{
    const key=`${m.sheet}-${m.flt}-${m.etd}-${m.gate}-${m.nameNormalized}`;
    if(unique.has(key)){
      const e=unique.get(key);
      e.supFlag = e.supFlag || m.supFlag;
      e.gateFlag = e.gateFlag || m.gateFlag;
      e.ketsoFlag = e.ketsoFlag || m.ketsoFlag;
      e.wlctFlag = e.wlctFlag || m.wlctFlag;
    } else unique.set(key, {...m});
  });
  matches=[...unique.values()];
  const grouped={};daysOrder.forEach(d=>grouped[d]=[]);
  matches.forEach(m=>grouped[m.sheet].push(m));
  const now=new Date();
  const vnWeekday=new Intl.DateTimeFormat('vi-VN',{timeZone:'Asia/Bangkok',weekday:'long'}).format(now).toLowerCase();
  const mapVN={'th·ª© hai':0,'th·ª© ba':1,'th·ª© t∆∞':2,'th·ª© nƒÉm':3,'th·ª© s√°u':4,'th·ª© b·∫£y':5,'ch·ªß nh·∫≠t':6};
  const todayIndex=mapVN[vnWeekday]??new Date().getDay()-1;

  let html="";
  daysOrder.forEach((day,idx)=>{
    const rows=grouped[day];
    const isPast=idx<todayIndex, isToday=idx===todayIndex;
    html+=`<div class="day-container ${isPast?'day-past':''} ${isToday?'day-today':''}">
      <div class="day-title">${day}</div>`;
    if(!rows.length){
      html+=`<p class="text-gray-400 italic">Kh√¥ng c√≥ d·ªØ li·ªáu</p>`;
    } else {
      html+=`<table class="w-full result-table mt-1"><thead><tr>
        <th>FLT</th><th>ETD</th><th>SUP</th><th>GATE</th><th>K·∫øt s·ªï</th><th>WLC</th><th>Boarding</th></tr></thead><tbody>`;
      rows.forEach(r=>{
        let brd=r.tag==="BRD"?"‚úÖ":r.tag==="NO"?"‚ùå":"";
        html+=`<tr>
          <td>${r.flt||'‚Äî'}</td>
          <td>${r.etd||'‚Äî'}</td>
          <td class="center">${r.supFlag?'‚úÖ':''}</td>
          <td class="center">${r.gateFlag?'‚úÖ':''}</td>
          <td class="center">${r.ketsoFlag?'‚úÖ':''}</td>
          <td class="center">${r.wlctFlag?'‚úÖ':''}</td>
          <td class="center">${brd}</td>
        </tr>`;
      });
      html+=`</tbody></table>`;
    }
    html+=`</div>`;
  });
  container.innerHTML=html;
  localStorage.setItem(SEARCH_STORAGE_KEY, nameRaw);
}

/* ========================================================
   T√çNH NƒÇNG "L√ÄM H·ªò" - CHECK AVAILABILITY RANGE (ƒê√É C·∫¨P NH·∫¨T: D√πng exactNameMatches)
   ======================================================== */
const team7c = ["H·∫¢I 9", "HUY 14", "D≈®NG 12", "KH·∫¢I 2", "HUY 12", "H·∫∞NG 14", "HUY·ªÄN 15", "LY 5", "THU 9", "L·∫¨P 2"];
const teamPR = ["NGHƒ®A 1", "TR√ÇM 3", "HO√ÄNG 10", "HUY 11", "TH√öY 7", "ANH 10", "TU·∫§N 11", "LY 2", "S∆†N 12", "KH√ÅNH 2"];

function checkHelp(){
    const fromH = parseFloat(c('help-from').value);
    const toH = parseFloat(c('help-to').value);
    const daySelect = c('help-day').value; 
    const use7c = c('chk-7c').checked;
    const usePR = c('chk-pr').checked;
    const resultList = c('help-list');
    const resultBox = c('help-result');

    if(isNaN(fromH) || isNaN(toH)){
        showToast("Vui l√≤ng nh·∫≠p gi·ªù ƒë·∫ßy ƒë·ªß (VD: 11 v√† 18.5)");
        return;
    }
    if(fromH >= toH){
        showToast("Gi·ªù k·∫øt th√∫c ph·∫£i l·ªõn h∆°n gi·ªù b·∫Øt ƒë·∫ßu!");
        return;
    }
    if(!employeeData.length){
        showToast("Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng t·∫£i Excel tr∆∞·ªõc.");
        return;
    }
    if(!use7c && !usePR){
        showToast("Ch·ªçn √≠t nh·∫•t 1 team!");
        return;
    }

    let targetNames = [];
    if(use7c) targetNames = [...targetNames, ...team7c];
    if(usePR) targetNames = [...targetNames, ...teamPR];

    let freeList = [];

    targetNames.forEach(rawName => {
        const normSearch = normalizeText(rawName);
        // S·ª≠ d·ª•ng exactNameMatches ƒë·ªÉ so kh·ªõp ch√≠nh x√°c t√™n team v·ªõi b·∫£ng ch·∫•m c√¥ng
        const emp = employeeData.find(e => exactNameMatches(normSearch, normalizeText(e.name)));
        
        if(!emp){
            freeList.push({name: rawName, reason: "Kh√¥ng c√≥ trong b·∫£ng CC"});
            return;
        }

        const shiftStr = emp[daySelect];
        if(!shiftStr){
            freeList.push({name: rawName, reason: "OFF"});
            return;
        }
        
        const parts = shiftStr.split(";").map(x=>x.trim()).filter(Boolean);
        let isBusy = false;
        
        for(let p of parts){
            const s = parseShift(p);
            if(s && !s.error && s.dur>0){ 
                const overlap = Math.max(fromH, s.start) < Math.min(toH, s.end);
                if(overlap) isBusy = true;
            }
        }

        if(!isBusy){
            freeList.push({name: rawName, reason: shiftStr});
        }
    });

    resultList.innerHTML = "";
    if(freeList.length === 0){
        resultList.innerHTML = "<li class='text-red-600 font-semibold'>Kh√¥ng c√≥ ai r·∫£nh trong kho·∫£ng n√†y!</li>";
    } else {
        freeList.forEach(item => {
            const li = document.createElement("li");
            li.innerHTML = `<span class="font-bold text-gray-800">${item.name}</span> <span class="text-xs text-gray-500">(${item.reason})</span>`;
            resultList.appendChild(li);
        });
    }
    resultBox.classList.remove("hidden");
}

c("btn-find-help").addEventListener("click", checkHelp);

/* --- Wire events --- */
c("search-name").addEventListener("input",e=>renderSuggestions(e.target.value||""));
c("search-name").addEventListener("keydown",e=>{
  if(e.key==="Enter"){e.preventDefault(); const val=e.target.value; if(val){ localStorage.setItem(SEARCH_STORAGE_KEY, val);} renderFlightResults(e.target.value);}
});

document.addEventListener("DOMContentLoaded",()=>{
  createInputs();fillWeekSelect();loadLastExcelData();
  const last=localStorage.getItem(SEARCH_STORAGE_KEY);
  if(last){c("search-name").value=last;setTimeout(()=>renderFlightResults(last),500);}
  c("save-week").onclick=saveWeek;
  c("week-select").onchange=e=>{const v=e.target.value;if(v){c("week-name").value=v;loadWeek(v);} };
  c("calc-week").onclick=calcWeek;
  c("clear-week").onclick=deleteWeek;
  c("clear-all").onclick=clearAll;
});
</script>

</body>
</html>
