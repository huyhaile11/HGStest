<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>L·ªäCH C·ªêNG HI·∫æN HGS - Mobile</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts & libs -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background:#f5f7ff; }
    .card { background:#fff; border-radius:1rem; box-shadow:0 4px 12px rgba(0,0,0,.08); }
    .toast {
      position: fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      background: rgba(99,102,241,0.95); color:white; padding:12px 20px; border-radius:10px;
      font-weight:600; z-index:9999; animation:fadeInOut 2s forwards;
    }
    @keyframes fadeInOut {
      0%{opacity:0;transform:translate(-50%,-55%)}
      10%,90%{opacity:1;transform:translate(-50%,-50%)}
      100%{opacity:0;transform:translate(-50%,-45%)}
    }
    textarea { font-family: monospace; }
  </style>
</head>
<body class="p-3">
  <div class="max-w-lg mx-auto card p-4 space-y-4">
    <!-- Header -->
    <div class="text-center">
      <h1 class="text-xl font-bold text-indigo-600">üìÖ L·ªäCH C·ªêNG HI·∫æN HGS</h1>
      <p class="text-sm text-gray-500 mt-1">Nh·∫≠p ca nh∆∞: S; X; A; HC; 1X; 1-X; X1; X-1; 0.5X-1... (h·ªó tr·ª£ ca g√£y)</p>
    </div>

    <!-- Tu·∫ßn, upload, paste, select -->
    <div class="space-y-2">
      <input id="week-name" type="text" placeholder="T√™n tu·∫ßn (VD: Tu·∫ßn 44 - Th√°ng 10)"
             class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400">

      <div class="flex gap-2 flex-wrap">
        <button id="save-week" class="flex-1 bg-indigo-600 text-white rounded-lg py-2 font-semibold">üíæ L∆∞u tu·∫ßn</button>
        <select id="week-select" class="flex-1 border border-gray-300 rounded-lg text-sm px-2 py-2">
          <option value="">Ch·ªçn tu·∫ßn</option>
        </select>
      </div>

      <div class="space-y-2">
        <div class="flex gap-2">
          <input type="file" id="excel-upload" accept=".xls,.xlsx" class="flex-1 border border-gray-300 rounded-lg px-2 py-2">
          <button id="paste-btn" class="flex-1 bg-indigo-600 text-white rounded-lg py-2 font-semibold">üìã D√°n d·ªØ li·ªáu Excel</button>
        </div>
        <textarea id="paste-area" rows="6" placeholder="D√°n d·ªØ li·ªáu t·ª´ Excel / Google Sheets v√†o ƒë√¢y (B‚ÜíW)..."
                  class="hidden w-full border border-gray-300 rounded-lg p-2 text-sm"></textarea>
        <select id="employee-select" class="w-full border border-gray-300 rounded-lg text-sm px-3 py-2">
          <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
        </select>
      </div>
    </div>

    <!-- C√°c ng√†y -->
    <div id="days-container" class="space-y-3"></div>

    <!-- N√∫t h√†nh ƒë·ªông -->
    <div class="grid grid-cols-1 gap-2">
      <button id="calc-week" class="w-full bg-indigo-600 text-white rounded-lg py-3 font-semibold">üìÖ T√≠nh l·ªãch tu·∫ßn</button>
      <button id="export-pdf" class="w-full bg-blue-600 text-white rounded-lg py-3 font-semibold">üì§ Xu·∫•t PDF</button>
      <button id="clear-week" class="w-full bg-yellow-500 text-white rounded-lg py-3 font-semibold">üßπ X√≥a tu·∫ßn n√†y</button>
      <button id="clear-all" class="w-full bg-red-500 text-white rounded-lg py-3 font-semibold">üóë X√≥a t·∫•t c·∫£</button>
    </div>

    <!-- K·∫øt qu·∫£ -->
    <div id="result-container" class="hidden">
      <div class="overflow-x-auto mt-3 rounded-lg border border-gray-200">
        <table class="w-full text-sm text-gray-700">
          <thead class="bg-indigo-100">
            <tr><th class="px-2 py-1 text-left">Th·ª©</th><th class="px-2 py-1 text-left">Ca</th><th class="px-2 py-1 text-center">Gi·ªù v√†o</th><th class="px-2 py-1 text-center">Gi·ªù ra</th><th class="px-2 py-1 text-center">T·ªïng</th></tr>
          </thead>
          <tbody id="result-body"></tbody>
        </table>
      </div>
      <p id="tribute" class="text-center font-bold text-red-600 mt-2 hidden">B·∫†N ƒê√É C·ªêNG HI·∫æN H·∫æT M√åNH C·∫¢ TU·∫¶N!</p>
    </div>

    <!-- ETD -->
    <div class="border-t pt-4 mt-4">
      <h2 class="text-lg font-semibold text-indigo-600 text-center mb-2">‚úàÔ∏è T√≠nh gi·ªù c√≥ m·∫∑t t·∫°i qu·∫ßy</h2>
      <div class="space-y-2">
        <input id="etd" type="text" placeholder="Nh·∫≠p ETD (HH:MM, v√≠ d·ª• 23:45)"
               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-base focus:ring-2 focus:ring-indigo-400"
               pattern="^([01]?[0-9]|2[0-3]):[0-5][0-9]$">
        <div class="flex justify-center gap-4">
          <label class="flex items-center gap-1 text-sm"><input type="radio" name="flight" value="ND" checked> N·ªôi ƒë·ªãa</label>
          <label class="flex items-center gap-1 text-sm"><input type="radio" name="flight" value="QT"> Qu·ªëc t·∫ø</label>
        </div>
        <button id="calc-etd" class="w-full bg-green-600 text-white rounded-lg py-2 font-semibold">‚è∞ T√≠nh gi·ªù c√≥ m·∫∑t</button>
        <p id="etd-result" class="text-center text-indigo-700 font-semibold mt-2"></p>
      </div>
    </div>

    <!-- Footer -->
    <p class="text-center text-sm font-semibold mt-4 bg-gradient-to-r from-indigo-500 via-blue-500 to-purple-500 bg-clip-text text-transparent drop-shadow-sm">
      ‚ú® Created by <span class="font-bold">H·∫£i 9</span> ‚ú®
    </p>
  </div>

  <div id="toast"></div>

  <script>
    /* ---------- helpers & state ---------- */
    const c = id => document.getElementById(id);
    const days = ["Th·ª© Hai","Th·ª© Ba","Th·ª© T∆∞","Th·ª© NƒÉm","Th·ª© S√°u","Th·ª© B·∫£y","Ch·ªß Nh·∫≠t"];
    const shifts = { HC:{start:7.5,end:15.5}, A:{start:22,end:30}, X:{start:14,end:22}, S:{start:6,end:14} };
    const showToast = msg => { const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),2000); };

    const fmt = t => String(Math.floor(t%24)).padStart(2,"0")+":"+String(Math.round((t%1)*60)).padStart(2,"0");

    // combine two cells (C+E etc), add semicolon if both, ignore OFF
    function combine(a,b){
      const v1 = (a||"").toString().trim().toUpperCase();
      const v2 = (b||"").toString().trim().toUpperCase();
      let combined = [v1, v2].filter(Boolean).join(";");
      if(!combined || combined.includes("OFF")) combined = "";
      return combined;
    }

    // localStorage helpers
    const saveWeeksList = arr => localStorage.setItem("weeks_list", JSON.stringify(arr));
    const loadWeeksList = ()=>JSON.parse(localStorage.getItem("weeks_list")||"[]");
    const keyWeek = n => "week_"+n;

    /* ---------- create day inputs ---------- */
    function createInputs(){
      const box = c("days-container");
      box.innerHTML = "";
      days.forEach((d,i)=>{
        box.innerHTML += `<div><label class="block text-sm font-semibold text-gray-700 mb-1">${d}</label>
          <input id="day${i}" type="text" placeholder="V√≠ d·ª•: S; X; 1X; X-1"
            class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-400"></div>`;
      });
    }
    createInputs();

    /* ---------- week save/load/delete ---------- */
    function saveWeek(){
      const n = c("week-name").value.trim(); if(!n){ showToast("Nh·∫≠p t√™n tu·∫ßn"); return; }
      const data = {};
      days.forEach((_,i)=> data["day"+i] = c("day"+i).value.trim());
      localStorage.setItem(keyWeek(n), JSON.stringify(data));
      let list = loadWeeksList(); if(!list.includes(n)){ list.push(n); saveWeeksList(list); fillWeekSelect(); }
      showToast("ƒê√£ l∆∞u tu·∫ßn "+n);
    }

    function fillWeekSelect(){
      const s = c("week-select"); const list = loadWeeksList();
      s.innerHTML = '<option value="">Ch·ªçn tu·∫ßn</option>';
      list.forEach(n=>{ const o=document.createElement("option"); o.value=n; o.textContent=n; s.appendChild(o); });
    }
    fillWeekSelect();

    function loadWeek(n){
      const raw = localStorage.getItem(keyWeek(n)); if(!raw){ showToast("Tu·∫ßn tr·ªëng"); return; }
      const d = JSON.parse(raw);
      days.forEach((_,i)=> c("day"+i).value = d["day"+i] || "");
      showToast("ƒê√£ t·∫£i "+n);
    }

    function deleteWeek(){
      const n = c("week-name").value.trim(); if(!n) return showToast("Nh·∫≠p t√™n tu·∫ßn");
      localStorage.removeItem(keyWeek(n));
      let list = loadWeeksList().filter(x=>x!==n); saveWeeksList(list); fillWeekSelect();
      days.forEach((_,i)=> c("day"+i).value = "");
      showToast("ƒê√£ x√≥a tu·∫ßn "+n);
    }

    function clearAll(){
      if(!confirm("X√≥a t·∫•t c·∫£ tu·∫ßn?")) return;
      loadWeeksList().forEach(n=>localStorage.removeItem(keyWeek(n)));
      saveWeeksList([]); fillWeekSelect(); days.forEach((_,i)=> c("day"+i).value="");
      showToast("ƒê√£ x√≥a t·∫•t c·∫£");
    }

    /* ---------- parse shift logic (same as tr∆∞·ªõc) ---------- */
    function parseShift(str){
      str = (str||"").toString().trim().toUpperCase();
      if(!str) return null;
      // special H, M, DH like H3, M2
      const s = /^([A-Z]{1,2})(\d+)?$/.exec(str);
      if(s && ["H","M","DH"].includes(s[1])) return { special: s[1], hours: +(s[2] || 0) };

      const re = /^(\d*\.?\d*-?)?([A-Z]{1,2})(-?\d*\.?\d*)?$/;
      const m = re.exec(str);
      if(!m) return { error: "Sai ƒë·ªãnh d·∫°ng" };
      const [, pre, code, suf] = m;
      if(!shifts[code]) return { error: "Ca kh√¥ng t·ªìn t·∫°i" };

      let { start, end } = shifts[code];

      if(pre){
        const clean = pre.replace("-","");
        const val = parseFloat(clean || 0);
        if(pre.includes("-")) start += val; else start -= val;
      }

      if(suf){
        const clean = suf.replace("-","");
        const val = parseFloat(clean || 0);
        if(suf.startsWith("-")) end -= val; else end += val;
      }

      if(start >= end) end += 24;
      return { start, end, dur: end - start };
    }

    /* ---------- calc week (display) ---------- */
    function calcWeek(){
      const tbody = c("result-body"); tbody.innerHTML = "";
      let total = 0, full = true;
      days.forEach((d,i)=>{
        const v = (c("day"+i).value || "").toString().trim();
        if(!v){ tbody.innerHTML += `<tr><td>${d}</td><td colspan=4 class="italic text-gray-400">Ngh·ªâ</td></tr>`; full = false; return; }
        let sum = 0;
        const parts = v.split(";").map(x=>x.trim()).filter(Boolean);
        parts.forEach((p,j)=>{
          const r = parseShift(p);
          if(r.error){
            tbody.innerHTML += `<tr><td>${j?"":d}</td><td>${p}</td><td colspan=3 class="text-red-600">${r.error}</td></tr>`;
            return;
          }
          if(r.special){
            tbody.innerHTML += `<tr><td>${j?"":d}</td><td>${p}</td><td colspan=2 class="text-center">${r.special=="H"?"H·ªçc":r.special=="M"?"H·ªçp":"D·∫°y"}</td><td>${r.hours}h</td></tr>`;
            sum += r.hours;
          } else {
            tbody.innerHTML += `<tr><td>${j?"":d}</td><td>${p}</td><td class="text-center">${fmt(r.start)}</td><td class="text-center">${fmt(r.end)}</td><td>${r.dur.toFixed(1)}h</td></tr>`;
            sum += r.dur;
          }
        });
        if(parts.length>1) tbody.innerHTML += `<tr class="bg-indigo-50 font-medium"><td></td><td colspan=3>T·ªïng ng√†y</td><td>${sum.toFixed(1)}h</td></tr>`;
        total += sum;
      });
      tbody.innerHTML += `<tr class="bg-indigo-100 font-bold"><td colspan=4>T·ªïng tu·∫ßn</td><td>${total.toFixed(1)}h</td></tr>`;
      c("result-container").classList.remove("hidden");
      c("tribute").classList.toggle("hidden", !full);
      showToast("ƒê√£ t√≠nh xong!");
    }

    /* ---------- ETD calc ---------- */
    function calcETD(){
      const val = c("etd").value.trim();
      if(!/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(val)) return showToast("Nh·∫≠p gi·ªù ETD d·∫°ng 24h (VD: 21:30)");
      const [h,m] = val.split(":").map(Number);
      let min = h*60 + m;
      const type = document.querySelector('input[name="flight"]:checked').value;
      const offset = (type==="QT") ? 220 : 160;
      min -= offset; if(min < 0) min += 1440;
      const H = Math.floor(min/60), M = min%60;
      c("etd-result").textContent = `üïí Gi·ªù c√≥ m·∫∑t: ${String(H).padStart(2,"0")}:${String(M).padStart(2,"0")}`;
      showToast("ƒê√£ t√≠nh gi·ªù c√≥ m·∫∑t!");
    }

    /* ---------- export PDF (with Vietnamese font) ---------- */
    async function exportPDF(){
      if(c("result-container").classList.contains("hidden")){ showToast("H√£y t√≠nh l·ªãch tr∆∞·ªõc!"); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation:"portrait", unit:"pt", format:"a4" });
      // load DejaVu font (script returns var DejaVuSansNormal)
      const fontUrl = "https://cdn.jsdelivr.net/gh/Trung0308/unicode-fonts/DejaVuSans-normal.js";
      try{
        const fontFile = await fetch(fontUrl).then(r=>r.text());
        eval(fontFile);
        doc.addFileToVFS("DejaVuSans-normal.ttf", DejaVuSansNormal);
        doc.addFont("DejaVuSans-normal.ttf", "DejaVuSans", "normal");
        doc.setFont("DejaVuSans");
      }catch(e){
        // fallback (may lose some Vietnamese glyphs)
        console.warn("Font load failed", e);
      }
      doc.setFontSize(16);
      doc.text("L·ªäCH C·ªêNG HI·∫æN HGS - "+(c("week-name").value||""), 40, 50);
      const rows = [...c("result-body").querySelectorAll("tr")].map(tr => [...tr.cells].map(td=>td.textContent));
      doc.autoTable({
        head: [["Th·ª©","Ca","Gi·ªù v√†o","Gi·ªù ra","T·ªïng"]],
        body: rows,
        startY: 70,
        styles: { font: "DejaVuSans", fontSize: 10 },
        headStyles: { fillColor:[99,102,241], textColor:255 }
      });
      doc.save("Lich_HGS.pdf");
      showToast("ƒê√£ xu·∫•t PDF (h·ªó tr·ª£ ti·∫øng Vi·ªát)");
    }

    /* ---------- Excel upload: read sheet "B·∫¢NG CH·∫§M C√îNG NH√ÇN VI√äN" ---------- */
    let employeeData = [];

    // parse array rows (shared by paste and sheet)
    function buildEmployeeListFromRows(rows){
      if(!rows || rows.length===0) return [];
      // If first row is header (contains 'T√™n' or 'B·∫¢NG'), drop it
      let startIndex = 0;
      const first = rows[0].map(cell => (cell||"").toString().toLowerCase()).join(" ");
      if(first.includes("t√™n") || first.includes("b·∫£ng") || first.includes("nh√¢n vi√™n")) startIndex = 1;
      const data = rows.slice(startIndex).map(row => ({
        name: (row[1] || "").toString().trim(),
        mon: combine(row[2], row[4]),
        tue: combine(row[5], row[7]),
        wed: combine(row[8], row[10]),
        thu: combine(row[11], row[13]),
        fri: combine(row[14], row[16]),
        sat: combine(row[17], row[19]),
        sun: combine(row[20], row[22])
      })).filter(e => e.name);
      return data;
    }

    // PASTE handler (for iPhone / clipboard)
    c("paste-btn").onclick = () => {
      c("paste-area").classList.toggle("hidden");
      if(!c("paste-area").classList.contains("hidden")) c("paste-area").focus();
    }
    function parsePasted(){
      const text = c("paste-area").value.trim();
      if(!text){ showToast("Kh√¥ng c√≥ d·ªØ li·ªáu!"); return; }
      // parse by lines, split by tab or comma
      const rows = text.split(/\r?\n/).map(r => r.split(/\t|,/));
      employeeData = buildEmployeeListFromRows(rows);
      if(employeeData.length===0){ showToast("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c d·ªØ li·ªáu!"); return; }
      populateEmployeeSelect();
      showToast("‚úÖ ƒê√£ ƒë·ªçc d·ªØ li·ªáu d√°n!");
    }
    c("paste-area").addEventListener("paste", ()=> setTimeout(parsePasted, 100));

    // EXCEL FILE upload (desktop/iPhone) - use readAsBinaryString for iOS compatibility
    c("excel-upload").addEventListener("change", (e) => {
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = (evt) => {
        // read as binary string to be compatible with iPhone's FileReader behaviour
        const binary = evt.target.result;
        const workbook = XLSX.read(binary, { type: "binary" });
        const sheetName = workbook.SheetNames.find(n => n && n.trim().toLowerCase() === "b·∫£ng ch·∫•m c√¥ng nh√¢n vi√™n".toLowerCase());
        if(!sheetName){ showToast("‚ùå Kh√¥ng t√¨m th·∫•y sheet 'B·∫¢NG CH·∫§M C√îNG NH√ÇN VI√äN'!"); return; }
        const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
        employeeData = buildEmployeeListFromRows(sheet);
        if(employeeData.length === 0){ showToast("‚ùå Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n n√†o!"); return; }
        populateEmployeeSelect();
        showToast("‚úÖ ƒê√£ t·∫£i danh s√°ch nh√¢n vi√™n!");
      };
      // Use binary read for better iOS compatibility
      reader.readAsBinaryString(file);
    });

    function populateEmployeeSelect(){
      const sel = c("employee-select");
      sel.innerHTML = '<option value="">-- Ch·ªçn nh√¢n vi√™n --</option>';
      employeeData.sort((a,b) => a.name.localeCompare(b.name, "vi", { sensitivity: "base" }))
        .forEach(e => { const opt = document.createElement("option"); opt.value = e.name; opt.textContent = e.name; sel.appendChild(opt); });
    }

    // when choose employee
    c("employee-select").addEventListener("change", (e) => {
      const name = e.target.value;
      if(!name) return;
      const emp = employeeData.find(x => x.name.trim().toLowerCase() === name.trim().toLowerCase());
      if(!emp) return showToast("Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n!");
      ["mon","tue","wed","thu","fri","sat","sun"].forEach((d,i) => c("day"+i).value = emp[d] || "");
      showToast("üìÖ ƒê√£ t·∫£i l·ªãch c·ªßa " + name);
    });

    /* ---------- wire up other buttons ---------- */
    document.addEventListener("DOMContentLoaded", ()=>{ /* createInputs already called */ fillWeekSelect(); });
    c("save-week").onclick = saveWeek;
    c("week-select").onchange = e => { const v = e.target.value; if(v){ c("week-name").value = v; loadWeek(v); } };
    c("calc-week").onclick = calcWeek;
    c("calc-etd").onclick = calcETD;
    c("export-pdf").onclick = exportPDF;
    c("clear-week").onclick = deleteWeek;
    c("clear-all").onclick = clearAll;

  </script>
</body>
</html>
