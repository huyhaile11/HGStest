<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>L·ªäCH C·ªêNG HI·∫æN HGS - Full</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background: #f5f7ff; }
    .card { background: #fff; border-radius: 1rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .toast {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: rgba(99,102,241,0.95); color: white; padding: 10px 18px;
      border-radius: 10px; font-weight: 600; z-index: 9999; animation: fadeInOut 2s forwards;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translate(-50%, -55%); }
      10%, 90% { opacity: 1; transform: translate(-50%, -50%); }
      100% { opacity: 0; transform: translate(-50%, -45%); }
    }
    #suggestions { z-index: 50; }
    table.result-table th, table.result-table td { padding: 8px 6px; border-bottom: 1px solid #eee; font-size: 13px; text-align:left; vertical-align: middle; }
    table.result-table td.center { text-align:center; }
    .board-yes { background: rgba(16,185,129,0.06); } /* xanh nh·∫°t */
    .board-no { background: rgba(239,68,68,0.06); }  /* ƒë·ªè nh·∫°t */
  </style>
</head>
<body class="p-3">
  <div class="max-w-lg mx-auto card p-4 space-y-4">
    <div class="text-center">
      <h1 class="text-xl font-bold text-indigo-600">üìÖ L·ªäCH C·ªêNG HI·∫æN HGS</h1>
      <p class="text-sm text-gray-500 mt-1">Nh·∫≠p ca nh∆∞: S; X; A; HC; 1X; 1-X; X1; X-1; 0.5X-1...</p>
    </div>

    <div class="space-y-2">
      <input id="week-name" type="text" placeholder="T√™n tu·∫ßn (VD: Tu·∫ßn 44 - Th√°ng 10)"
             class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-400">
      <div class="flex gap-2 flex-wrap">
        <button id="save-week" class="flex-1 bg-indigo-600 text-white rounded-lg py-2 font-semibold">üíæ L∆∞u tu·∫ßn</button>
        <select id="week-select" class="flex-1 border border-gray-300 rounded-lg text-sm px-2 py-2">
          <option value="">Ch·ªçn tu·∫ßn</option>
        </select>
      </div>

      <div class="space-y-2">
        <input type="file" id="excel-upload" accept=".xls,.xlsx"
               class="w-full border border-gray-300 rounded-lg text-sm px-3 py-2">
        <select id="employee-select"
                class="w-full border border-gray-300 rounded-lg text-sm px-3 py-2">
          <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
        </select>
      </div>
    </div>

    <div id="days-container" class="space-y-3"></div>

    <div class="grid grid-cols-1 gap-2">
      <button id="calc-week" class="w-full bg-indigo-600 text-white rounded-lg py-3 font-semibold">üìÖ T√≠nh l·ªãch tu·∫ßn</button>
      <button id="clear-week" class="w-full bg-yellow-500 text-white rounded-lg py-3 font-semibold">üßπ X√≥a tu·∫ßn n√†y</button>
      <button id="clear-all" class="w-full bg-red-500 text-white rounded-lg py-3 font-semibold">üóë X√≥a t·∫•t c·∫£</button>
    </div>

    <div id="result-container" class="hidden">
      <div class="overflow-x-auto mt-3 rounded-lg border border-gray-200">
        <table class="w-full text-sm text-gray-700">
          <thead class="bg-indigo-100">
            <tr>
              <th class="px-2 py-1 text-left">Th·ª©</th>
              <th class="px-2 py-1 text-left">Ca</th>
              <th class="px-2 py-1 text-center">Gi·ªù v√†o</th>
              <th class="px-2 py-1 text-center">Gi·ªù ra</th>
              <th class="px-2 py-1 text-center">T·ªïng</th>
            </tr>
          </thead>
          <tbody id="result-body"></tbody>
        </table>
      </div>
      <p id="tribute" class="text-center font-bold text-red-600 mt-2 hidden">B·∫†N ƒê√É C·ªêNG HI·∫æN H·∫æT M√åNH C·∫¢ TU·∫¶N!</p>

      <p class="text-center mt-3 font-semibold text-indigo-600 text-sm bg-indigo-50 py-2 rounded-lg shadow-sm">‚ú® Created by H·∫£i 9 ‚ú®</p>
    </div>

    <div class="border-t pt-4 mt-4">
      <h2 class="text-lg font-semibold text-indigo-600 text-center mb-2">üîç Tra c·ª©u chuy·∫øn bay</h2>
      <div class="space-y-2">
        <input id="search-name" type="text" placeholder="Nh·∫≠p t√™n nh√¢n vi√™n (VD: H·∫¢I 9 ho·∫∑c Hai 9)"
               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-base focus:ring-2 focus:ring-indigo-400"
               autocomplete="off">
        <div id="suggestions" class="bg-white border border-gray-200 rounded-lg shadow hidden max-h-40 overflow-y-auto"></div>
        <div id="flight-result" class="mt-3 text-sm"></div>
      </div>
    </div>

  </div>

  <div id="toast"></div>

<script>
  /* ======== INIT MINIMAL - hi·ªÉn th·ªã khung nh·∫≠p ca ======== */
  document.addEventListener("DOMContentLoaded", () => {
    const days = ["Th·ª© Hai","Th·ª© Ba","Th·ª© T∆∞","Th·ª© NƒÉm","Th·ª© S√°u","Th·ª© B·∫£y","Ch·ªß Nh·∫≠t"];
    const box = document.getElementById("days-container");
    box.innerHTML = "";
    days.forEach((d,i)=>{
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `<label class="block text-sm font-semibold text-gray-700 mb-1">${d}</label>
        <input id="day${i}" type="text" placeholder="V√≠ d·ª•: S; X; 1X; X-1"
        class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-400">`;
      box.appendChild(wrapper);
    });
  });
</script>

<script>
/* ================= PART 2/2: JAVASCRIPT HO√ÄN CH·ªàNH - ƒê√£ S·ª≠a ƒê·ªïi ================= */

/* ---------------- Helpers & state ---------------- */
const c = id => document.getElementById(id);
const days = ["Th·ª© Hai","Th·ª© Ba","Th·ª© T∆∞","Th·ª© NƒÉm","Th·ª© S√°u","Th·ª© B·∫£y","Ch·ªß Nh·∫≠t"];
const daysOrder = ["MON","TUE","WED","THU","FRI","SAT","SUN"];

let employeeData = []; // from b·∫£ng ch·∫•m c√¥ng QT / Nƒê
let flightData = [];   // parsed tokens from MON..SUN

const showToast = msg => {
  const t = document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t);
  setTimeout(()=>t.remove(),2000);
};

/* Remove diacritics and normalize string for matching (returns uppercase no-diacritics) */
function removeDiacritics(str){
  if(!str) return "";
  // Normalize and remove combining diacritical marks
  const s = str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  // Replace ƒê/ƒë with D/d
  return s.replace(/ƒë/g,'d').replace(/ƒê/g,'D');
}
function normalizeText(s){
  return removeDiacritics((s||"").toString().trim().replace(/\s+/g,' ').toUpperCase());
}

/* ---------------- UI: create inputs, week storage ---------------- */
function createInputs(){
  const box = c("days-container");
  box.innerHTML = "";
  days.forEach((d,i)=>{
    const wrapper = document.createElement('div');
    wrapper.innerHTML = `<label class="block text-sm font-semibold text-gray-700 mb-1">${d}</label>
      <input id="day${i}" type="text" placeholder="V√≠ d·ª•: S; X; 1X; X-1"
      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-400">`;
    box.appendChild(wrapper);
  });
}

const saveWeeksList = arr => localStorage.setItem("weeks_list", JSON.stringify(arr));
const loadWeeksList = ()=>JSON.parse(localStorage.getItem("weeks_list")||"[]");
const keyWeek = n => "week_"+n;

const saveWeek = ()=> {
  const n = c("week-name").value.trim();
  if(!n){ showToast("Nh·∫≠p t√™n tu·∫ßn"); return; }
  const data = {};
  days.forEach((_,i)=> data["day"+i] = c("day"+i).value.trim());
  localStorage.setItem(keyWeek(n), JSON.stringify(data));
  let list = loadWeeksList(); if(!list.includes(n)){ list.push(n); saveWeeksList(list); fillWeekSelect(); }
  showToast("ƒê√£ l∆∞u tu·∫ßn "+n);
};

const fillWeekSelect = ()=> {
  const s = c("week-select"); if(!s) return;
  const list = loadWeeksList();
  s.innerHTML = '<option value="">Ch·ªçn tu·∫ßn</option>';
  list.forEach(n=>{ const o = document.createElement('option'); o.value=n; o.textContent=n; s.appendChild(o); });
};

const loadWeek = n => {
  const raw = localStorage.getItem(keyWeek(n));
  if(!raw){ showToast("Tu·∫ßn tr·ªëng"); return; }
  const d = JSON.parse(raw);
  days.forEach((_,i)=> c("day"+i).value = d["day"+i]||"");
  showToast("ƒê√£ t·∫£i "+n);
};

const deleteWeek = ()=> {
  const n = c("week-name").value.trim();
  if(!n) return showToast("Nh·∫≠p t√™n tu·∫ßn");
  localStorage.removeItem(keyWeek(n));
  let list = loadWeeksList().filter(x=>x!==n); saveWeeksList(list); fillWeekSelect();
  days.forEach((_,i)=> c("day"+i).value="");
  showToast("ƒê√£ x√≥a tu·∫ßn "+n);
};

const clearAll = ()=> {
  if(!confirm("X√≥a t·∫•t c·∫£ tu·∫ßn?")) return;
  loadWeeksList().forEach(n=>localStorage.removeItem(keyWeek(n)));
  saveWeeksList([]); fillWeekSelect(); days.forEach((_,i)=> c("day"+i).value="");
  showToast("ƒê√£ x√≥a t·∫•t c·∫£");
};

/* ---------------- Shift parsing & week calc (kept) ---------------- */
const shifts = { HC:{start:7.5,end:15.5}, A:{start:22,end:30}, X:{start:14,end:22}, S:{start:6,end:14} };

function parseShift(str){
  str = (str||"").toString().trim().toUpperCase();
  if(!str) return null;
  const s = /^([A-Z]{1,2})(\d+)?$/.exec(str);
  if(s && ["H","M","DH"].includes(s[1])) return { special: s[1], hours: +(s[2]||0) };
  const re = /^(\d*\.?\d*-?)?([A-Z]{1,2})(-?\d*\.?\d*)?$/;
  const m = re.exec(str);
  if(!m) return { error: "Sai ƒë·ªãnh d·∫°ng" };
  const [, pre, code, suf] = m;
  if(!shifts[code]) return { error: "Ca kh√¥ng t·ªìn t·∫°i" };
  let { start, end } = shifts[code];
  if(pre){ const clean = pre.replace("-",""); const val = parseFloat(clean || 0); if(pre.includes("-")) start += val; else start -= val; }
  if(suf){ const clean = suf.replace("-",""); const val = parseFloat(clean || 0); if(suf.startsWith("-")) end -= val; else end += val; }
  if(start >= end) end += 24;
  return { start, end, dur: end - start };
}

function fmtHoursToHHMM(t){
  const hh = Math.floor(t % 24);
  const mm = Math.round((t % 1) * 60);
  return String(hh).padStart(2,"0")+":"+String(mm).padStart(2,"0");
}

function calcWeek(){
  const tbody = c("result-body"); if(!tbody) return;
  tbody.innerHTML = ""; let total=0, full=true;
  days.forEach((d,i)=>{
    const v = c("day"+i).value.trim();
    if(!v){ tbody.innerHTML += `<tr><td>${d}</td><td colspan=4 class="italic text-gray-400">Ngh·ªâ</td></tr>`; full=false; return; }
    let sum=0; const parts = v.split(";").map(x=>x.trim()).filter(Boolean);
    parts.forEach((p,j)=>{
      const r = parseShift(p);
      if(r && r.error){ tbody.innerHTML += `<tr><td>${j? "": d}</td><td>${p}</td><td colspan=3 class="text-red-600">${r.error}</td></tr>`; return; }
      if(r && r.special){ tbody.innerHTML += `<tr><td>${j? "": d}</td><td>${p}</td><td colspan=2 class="text-center">${r.special=="H"?"H·ªçc":r.special=="M"?"H·ªçp":"D·∫°y"}</td><td>${r.hours}h</td></tr>`; sum+=r.hours; }
      else if(r){ tbody.innerHTML += `<tr><td>${j? "": d}</td><td>${p}</td><td class="text-center">${fmtHoursToHHMM(r.start)}</td><td class="text-center">${fmtHoursToHHMM(r.end)}</td><td>${r.dur.toFixed(1)}h</td></td></tr>`; sum+=r.dur; }
      else { tbody.innerHTML += `<tr><td>${j? "": d}</td><td>${p}</td><td colspan=3 class="text-red-600">Kh√¥ng x√°c ƒë·ªãnh</td></tr>`; }
    });
    if(parts.length>1) tbody.innerHTML += `<tr class="bg-indigo-50 font-medium"><td></td><td colspan=3>T·ªïng ng√†y</td><td>${sum.toFixed(1)}h</td></tr>`;
    total += sum;
  });
  tbody.innerHTML += `<tr class="bg-indigo-100 font-bold"><td colspan=4>T·ªïng tu·∫ßn</td><td>${total.toFixed(1)}h</td></tr>`;
  c("result-container").classList.remove("hidden");
  c("tribute").classList.toggle("hidden", !full);
  showToast("ƒê√£ t√≠nh xong!");
}

/* ---------------- Excel parsing & flightData building (UPDATED) ---------------- */

/* combine helper for employee sheet (kept) */
function combine(a,b){
  const v1 = (a||"").toString().trim();
  const v2 = (b||"").toString().trim();
  let combined = [v1,v2].filter(Boolean).join(";");
  if(!combined || combined.toUpperCase().includes("OFF")) combined = "";
  return combined;
}

/* parseSheet unchanged (for employee-select) (kept) */
function parseSheet(sheet, sheetName){
  const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
  if(rows.length < 2) return [];
  return rows.slice(1).map(row => ({
    name: (row[1] || "").toString().trim(),
    mon: combine(row[2], row[4]),
    tue: combine(row[5], row[7]),
    wed: combine(row[8], row[10]),
    thu: combine(row[11], row[13]),
    fri: combine(row[14], row[16]),
    sat: combine(row[17], row[19]),
    sun: combine(row[20], row[22]),
    source: sheetName
  })).filter(e => e.name);
}

/* Parse tokens like "H·∫¢I 9", "HAI 9", "L√ÇM 3 K√àM QU·∫¶Y", "ANH 51 KO BRD" (kept) */
function parseNameToken(token){
  if(!token) return null;
  let raw = token.toString().trim();
  if(!raw) return null;
  raw = raw.replace(/\s+/g,' ').trim();

  // detect BRD/KO BRD patterns
  const negativePattern = /\b(KO|K)\s*(BRD|BD)\b/i;
  const positivePattern = /\b(BRD|BD)\b/i;
  let tag = "";
  if(negativePattern.test(raw)) tag = "NO";
  else if(positivePattern.test(raw)) tag = "BRD";

  // notes: k√®m qu·∫ßy
  const notes = [];
  if(/\bK[E√ä]M\s*QU·∫¶Y\b/i.test(raw)) notes.push("K√àM QU·∫¶Y");

  // match name + number: allow unicode letters (including ƒê)
  const nameNumPattern = /([\p{L}ƒêƒë]+(?:\s+[\p{L}ƒêƒë]+)*)\s*(\d+)/u;
  const m = raw.match(nameNumPattern);
  if(m){
    const namePart = m[1].trim();
    const num = m[2].trim();
    const combined = `${namePart} ${num}`.toUpperCase();
    return { nameOnly: combined, tag, notes };
  }

  // fallback: last tokens
  const words = raw.split(/\s+/);
  const last = words[words.length-1];
  if(/\d+/.test(last)){
    const possible = words.slice(-2).join(' ').toUpperCase();
    return { nameOnly: possible, tag, notes };
  }

  return { nameOnly: raw.toUpperCase(), tag, notes };
}

/* excel time helper (kept) */
function excelTimeToHHMM(v){
  if(v === undefined || v === null) return "";
  if(typeof v === 'string') return v.trim();
  if(typeof v === 'number'){
    const frac = v - Math.floor(v);
    const totalMinutes = Math.round(frac * 24 * 60);
    const H = Math.floor(totalMinutes / 60);
    const M = totalMinutes % 60;
    return String(H).padStart(2,'0') + ':' + String(M).padStart(2,'0');
  }
  return String(v);
}

/* Parse MON..SUN sheet: UPDATED COLUMNS and ROWS */
function parseFlightSheet(sheet, sheetName){
  const out = [];
  const startRow = 4, endRow = 58; // D√≤ng 4 ƒë·∫øn 58
  const startCol = XLSX.utils.decode_col('V'); // C·ªôt V
  const endCol = XLSX.utils.decode_col('AL'); // C·ªôt AL
  
  for(let r = startRow; r <= endRow; r++){
    // C·∫≠p nh·∫≠t v·ªã tr√≠ c·ªôt FLT, ETD, GATE
    const fltCell = sheet['Q' + r]; // Q
    const etdCell = sheet['R' + r]; // R
    const gateCell = sheet['G' + r]; // G (Gi·ªØ nguy√™n)

    const fltVal = fltCell ? (fltCell.v||'').toString().trim() : '';
    const etdVal = excelTimeToHHMM(etdCell ? etdCell.v : '');
    const gateVal = gateCell ? (gateCell.v||'').toString().trim() : '';
    
    // N·∫øu kh√¥ng c√≥ chuy·∫øn bay, b·ªè qua h√†ng n√†y
    if(!fltVal) continue;

    for(let c = startCol; c <= endCol; c++){
      const colLetter = XLSX.utils.encode_col(c);
      const addr = colLetter + r;
      const cell = sheet[addr];
      if(!cell || cell.v === undefined || cell.v === null) continue;
      let raw = String(cell.v).trim();
      if(!raw) continue;

      // split by common separators (kept)
      let parts = raw.split(/[,;\n]+/).map(x=>x.trim()).filter(Boolean);

      // if single long string, try to extract sequences of Name Number (kept)
      if(parts.length === 1){
        const found = raw.match(/[\p{L}ƒêƒë]+(?:\s+[\p{L}ƒêƒë]+)*\s*\d+/ug);
        if(found && found.length>0){
          parts = found.map(x=>x.trim());
        } else {
          // fallback split by 2+ spaces
          const bySpaces = raw.split(/\s{2,}/).map(x=>x.trim()).filter(Boolean);
          if(bySpaces.length>1) parts = bySpaces;
        }
      }

      // Determine the flags for the current column
      const isSup = colLetter === 'V';
      const isGate = colLetter === 'W';
      const isKetso = colLetter === 'X';
      const isWlct = colLetter === 'Y';
      
      parts.forEach(part=>{
        const parsed = parseNameToken(part);
        if(!parsed) return;

        const normalizedName = normalizeText(parsed.nameOnly);

        out.push({
          sheet: sheetName,
          row: r,
          col: colLetter,
          tokenRaw: part,
          nameOnly: parsed.nameOnly,
          nameNormalized: normalizedName,
          tag: parsed.tag,
          notes: parsed.notes || [],
          flt: fltVal,
          etd: etdVal,
          gate: gateVal,
          supFlag: isSup,
          gateFlag: isGate,
          ketsoFlag: isKetso,
          wlctFlag: isWlct,
          // Th√™m m·ªôt tr∆∞·ªùng ƒë·ªÉ d·ªÖ d√†ng l·ªçc tr√πng:
          uniqueKey: `${sheetName}-${fltVal}-${etdVal}-${gateVal}-${normalizedName}-${colLetter}`
        });
      });
    }
  }
  return out;
}

/* ---------------- File upload handling (kept) ---------------- */
c("excel-upload").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (evt) => {
    try {
      const data = new Uint8Array(evt.target.result);
      const workbook = XLSX.read(data, { type: "array" });

      // parse employee sheets
      const targetSheets = ["b·∫£ng ch·∫•m c√¥ng qt", "b·∫£ng ch·∫•m c√¥ng nƒë"];
      let allEmployees = [];
      targetSheets.forEach(target => {
        const sheetName = workbook.SheetNames.find(n => n.trim().toLowerCase() === target);
        if(sheetName){
          const sheet = workbook.Sheets[sheetName];
          const parsed = parseSheet(sheet, sheetName);
          allEmployees = allEmployees.concat(parsed);
        }
      });
      employeeData = allEmployees;
      const sel = c("employee-select");
      sel.innerHTML = '<option value="">-- Ch·ªçn nh√¢n vi√™n --</option>';
      employeeData.sort((a,b)=> a.name.localeCompare(b.name,"vi",{sensitivity:"base"})).forEach(e=>{
        const opt = document.createElement('option'); opt.value = e.name; opt.textContent = e.name + " (" + e.source.toUpperCase().replace("B·∫¢NG CH·∫§M C√îNG ","") + ")"; sel.appendChild(opt);
      });
      showToast("ƒê√£ t·∫£i d·ªØ li·ªáu QT & Nƒê (n·∫øu c√≥)");

      // parse MON..SUN
      flightData = [];
      daysOrder.forEach(d => {
        const sheetName = workbook.SheetNames.find(n => n.trim().toUpperCase() === d);
        if(sheetName){
          const sheet = workbook.Sheets[sheetName];
          const parsed = parseFlightSheet(sheet, d);
          flightData = flightData.concat(parsed);
        }
      });

      // prepare auxiliary maps for suggestions (unique normalized names -> display name)
      // Not stored globally, will compute on demand in renderSuggestions.
      if(flightData.length) showToast("‚úÖ ƒê√£ t·∫£i d·ªØ li·ªáu MON..SUN");
      else showToast("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y sheet MON..SUN (ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu)");

    } catch(err){
      console.error(err);
      showToast("‚ùå L·ªói ƒë·ªçc file Excel");
    }
  };
  reader.readAsArrayBuffer(file);
});

/* ---------------- employee-select behavior (kept) ---------------- */
c("employee-select").addEventListener("change", (e) => {
  const name = e.target.value;
  if(!name) return;
  const emp = employeeData.find(x => x.name.trim().toLowerCase() === name.trim().toLowerCase());
  if(!emp) return showToast("Kh√¥ng t√¨m th·∫•y nh√¢n vi√™n!");
  ["mon","tue","wed","thu","fri","sat","sun"].forEach((d,i)=> c("day"+i).value = emp[d] || "");
  showToast("ƒê√£ t·∫£i l·ªãch c·ªßa "+name);
});

/* ---------------- Search helpers & rendering (UPDATED DE-DUPE LOGIC) ---------------- */

/* Loose name match using normalized (no-diacritics) forms (kept) */
function nameMatchesNormalized(searchNorm, tokenNorm){
  if(!searchNorm || !tokenNorm) return false;
  return tokenNorm.includes(searchNorm) || searchNorm.includes(tokenNorm);
}

/* Suggestion dropdown: show display names but match on normalized (kept) */
function renderSuggestions(query){
  const box = c("suggestions");
  if(!box) return;
  if(!query){ box.classList.add("hidden"); return; }
  if(!flightData.length){ box.classList.add("hidden"); return; }

  const qNorm = normalizeText(query);

  // Build map: normalized -> first display name (preserve diacritics if present)
  const map = new Map();
  flightData.forEach(d => {
    if(!d.nameNormalized) return;
    if(!map.has(d.nameNormalized)) map.set(d.nameNormalized, d.nameOnly);
  });

  // find matches where normalized includes qNorm
  const matches = [...map.entries()].filter(([norm, display]) => norm.includes(qNorm)).map(([norm,display])=>({norm,display}));

  if(matches.length === 0){ box.classList.add("hidden"); return; }

  // sort by display
  matches.sort((a,b)=> a.display.localeCompare(b.display,"vi",{sensitivity:"base"}));

  box.innerHTML = matches.map(m => `<div class="px-3 py-2 hover:bg-indigo-50 cursor-pointer" data-n="${m.norm}">${m.display}</div>`).join("");
  box.classList.remove("hidden");
  box.querySelectorAll("div").forEach(div => {
    div.onclick = () => { 
      const display = div.textContent;
      c("search-name").value = display;
      box.classList.add("hidden");
      renderFlightResults(display);
    };
  });
}

/* Render results table using normalized matching (search can be provided with or without diacritics) */
function renderFlightResults(nameRaw){
  const container = c("flight-result");
  if(!container) return;
  if(!flightData.length){ container.innerHTML = `<p class="text-center text-gray-500 italic">Ch∆∞a c√≥ d·ªØ li·ªáu MON..SUN. H√£y t·∫£i file Excel.</p>`; return; }

  const qNorm = normalizeText(nameRaw);
  // find records whose nameNormalized loosely matches qNorm
  let matches = flightData.filter(d => nameMatchesNormalized(qNorm, d.nameNormalized));
  
  if(!matches.length){ container.innerHTML = `<p class="text-center text-gray-500 italic">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho "${nameRaw}"</p>`; return; }

  // LOGIC DE-DUPLICATION: Ch·ªâ gi·ªØ l·∫°i m·ªôt b·∫£n ghi (record) cho m·ªói b·ªô (Day, Flt, ETD, Gate, NormalizedName)
  const uniqueMatchesMap = new Map();
  matches.forEach(m => {
    // T·∫°o kh√≥a ƒë·ªôc nh·∫•t (Unique Key) cho m·ªói chuy·∫øn bay/ng√†y/nh√¢n vi√™n
    // (B·ªè c·ªôt kh·ªèi key ƒë·ªÉ g·ªôp c√°c vai tr√≤ V, W, X, Y v√†o c√πng 1 d√≤ng)
    const flightKey = `${m.sheet}-${m.flt}-${m.etd}-${m.gate}-${m.nameNormalized}`; 
    
    if (uniqueMatchesMap.has(flightKey)) {
      // N·∫øu ƒë√£ t·ªìn t·∫°i, c·∫≠p nh·∫≠t c·ªù (flag) cho record hi·ªán t·∫°i
      const existing = uniqueMatchesMap.get(flightKey);
      existing.supFlag = existing.supFlag || m.supFlag;
      existing.gateFlag = existing.gateFlag || m.gateFlag;
      existing.ketsoFlag = existing.ketsoFlag || m.ketsoFlag;
      existing.wlctFlag = existing.wlctFlag || m.wlctFlag;
      // C·∫≠p nh·∫≠t tag Boarding (ch·ªâ ∆∞u ti√™n BRD/NO n·∫øu ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh)
      if (m.tag === "BRD") existing.tag = "BRD";
      else if (m.tag === "NO" && existing.tag !== "BRD") existing.tag = "NO";
      // G·ªôp notes n·∫øu c·∫ßn
      m.notes.forEach(note => { if (!existing.notes.includes(note)) existing.notes.push(note); });
    } else {
      // N·∫øu ch∆∞a t·ªìn t·∫°i, th√™m v√†o map
      uniqueMatchesMap.set(flightKey, m);
    }
  });

  // Chuy·ªÉn l·∫°i th√†nh m·∫£ng
  matches = Array.from(uniqueMatchesMap.values());
  
  // group by sheet/day preserving order MON..SUN
  const grouped = {};
  daysOrder.forEach(d => grouped[d] = []);
  matches.forEach(m => grouped[m.sheet] = (grouped[m.sheet]||[]).concat(m));

  let html = `<div class="overflow-x-auto"><table class="w-full result-table"><thead><tr class="bg-indigo-100"><th>Ng√†y</th><th>FLT</th><th>ETD</th><th>GATE</th><th>SUP</th><th>GATE (flag)</th><th>K·∫øt s·ªï</th><th>WLC/XTAY</th><th>Boarding</th></tr></thead><tbody>`;

  for(const day of daysOrder){
    const rows = grouped[day] || [];
    if(rows.length === 0){
      html += `<tr class="text-gray-400"><td>${day}</td><td colspan="8">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
      continue;
    }
    rows.forEach(r => {
      // Boarding text
      let boardingText = '';
      let rowClass = '';
      if(r.tag === "BRD"){
        boardingText = '‚úÖ C√≥';
        if(r.notes && r.notes.includes("K√àM QU·∫¶Y")) boardingText += ' (K√®m qu·∫ßy)';
        rowClass = 'board-yes';
      } else if(r.tag === "NO"){
        boardingText = '‚ùå Kh√¥ng';
        if(r.notes && r.notes.includes("K√àM QU·∫¶Y")) boardingText += ' (K√®m qu·∫ßy)';
        rowClass = 'board-no';
      } else {
        boardingText = '';
      }

      html += `<tr class="${rowClass}">
        <td>${day}</td>
        <td>${r.flt || '‚Äî'}</td>
        <td>${r.etd || '‚Äî'}</td>
        <td>${r.gate || ''}</td>
        <td class="center">${ r.supFlag ? '‚úÖ' : '' }</td>
        <td class="center">${ r.gateFlag ? '‚úÖ' : '' }</td>
        <td class="center">${ r.ketsoFlag ? '‚úÖ' : '' }</td>
        <td class="center">${ r.wlctFlag ? '‚úÖ' : '' }</td>
        <td class="center">${boardingText}</td>
      </tr>`;
    });
  }

  html += `</tbody></table></div>`;
  container.innerHTML = html;
}

/* Wire search input events (kept) */
c("search-name").addEventListener("input", e => renderSuggestions(e.target.value || ""));
c("search-name").addEventListener("keydown", e => {
  if(e.key === "Enter"){ e.preventDefault(); const q = c("search-name").value.trim(); if(q) renderFlightResults(q); }
});

/* ---------------- Init & wiring (kept) ---------------- */
document.addEventListener("DOMContentLoaded", () => {
  createInputs();
  fillWeekSelect();

  const btnSave = c("save-week"); if(btnSave) btnSave.onclick = saveWeek;
  const selWeek = c("week-select"); if(selWeek) selWeek.onchange = e => { const v = e.target.value; if(v){ c("week-name").value = v; loadWeek(v); } };
  const btnCalc = c("calc-week"); if(btnCalc) btnCalc.onclick = calcWeek;
  const btnClear = c("clear-week"); if(btnClear) btnClear.onclick = deleteWeek;
  const btnClearAll = c("clear-all"); if(btnClearAll) btnClearAll.onclick = clearAll;
});

</script>


</body>
</html>
