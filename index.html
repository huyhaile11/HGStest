<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>L·ªäCH C·ªêNG HI·∫æN HGS - Xanh nh·∫°t (Fix TH∆Ø∆†NG 4)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #eef4fb;
      color: #1f2937;
    }

    .card {
      background: #ffffff;
      border-radius: 1rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(59,130,246,0.95);
      color: white;
      padding: 10px 18px;
      border-radius: 10px;
      font-weight: 600;
      z-index: 9999;
      animation: fadeInOut 2s forwards;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translate(-50%, -55%); }
      10%, 90% { opacity: 1; transform: translate(-50%, -50%); }
      100% { opacity: 0; transform: translate(-50%, -45%); }
    }

    #suggestions { z-index: 50; }

    table.result-table th,
    table.result-table td {
      padding: 8px 6px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 13px;
      text-align:left;
      vertical-align: middle;
    }

    table.result-table td.center { text-align:center; }

    .board-yes { background: rgba(59,130,246,0.08); } /* xanh d∆∞∆°ng nh·∫°t */
    .board-no { background: rgba(239,68,68,0.08); }   /* ƒë·ªè nh·∫°t */

    .day-container {
      background: white;
      border: 1px solid #dbeafe;
      border-radius: 10px;
      padding: 10px 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.03);
    }

    .day-title {
      font-weight: 700;
      font-size: 15px;
      padding: 4px 0;
      color: #2563eb;
    }

    .day-past { opacity: 0.6; background: #f8fafc; }
    .day-today {
      border: 2px solid #3b82f6;
      box-shadow: 0 0 10px rgba(59,130,246,0.15);
    }

    .small-muted { font-size:12px; color:#6b7280; }

    .btn-main {
      background: #3b82f6;
      color: white;
      border-radius: 8px;
      padding: 10px 0;
      font-weight: 600;
      width: 100%;
    }
    .btn-main:hover { background: #2563eb; }

    .btn-danger {
      background: #ef4444;
      color: white;
      border-radius: 8px;
      padding: 10px 0;
      font-weight: 600;
      width: 100%;
    }

    .btn-yellow {
      background: #facc15;
      color: #1f2937;
      border-radius: 8px;
      padding: 10px 0;
      font-weight: 600;
      width: 100%;
    }
  </style>
</head>

<body class="p-3">
  <div class="max-w-lg mx-auto card p-4 space-y-4">
    <div class="text-center">
      <h1 class="text-xl font-bold text-blue-600">üìÖ L·ªäCH "C·ªêNG HI·∫æN" HGS</h1>
      <p class="text-sm text-gray-500 mt-1">
        Nh·∫≠p ca nh∆∞: S; X; A; HC; 1X; 1-X; X1; X-1; 0.5X-1...
      </p>
    </div>

    <div class="space-y-2">
      <input id="week-name" type="text" placeholder="T√™n tu·∫ßn (VD: Tu·∫ßn 44 - Th√°ng 10)"
             class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400">
      <div class="flex gap-2 flex-wrap">
        <button id="save-week" class="flex-1 btn-main">üíæ L∆∞u tu·∫ßn</button>
        <select id="week-select" class="flex-1 border border-gray-300 rounded-lg text-sm px-2 py-2">
          <option value="">Ch·ªçn tu·∫ßn</option>
        </select>
      </div>

      <div class="space-y-2">
        <input type="file" id="excel-upload" accept=".xls,.xlsx"
               class="w-full border border-gray-300 rounded-lg text-sm px-3 py-2">
        <p class="text-xs text-gray-500 mt-1">
          (ƒê·ªÉ xem l·ªãch v√† chuy·∫øn bay c·ªßa t·∫•t c·∫£ m·ªçi ng∆∞·ªùi, h√£y t·∫£i file Excel v√† upload l√™n web)
        </p>
        <select id="employee-select"
                class="w-full border border-gray-300 rounded-lg text-sm px-3 py-2">
          <option value="">-- Ch·ªçn nh√¢n vi√™n --</option>
        </select>
      </div>
    </div>

    <div id="days-container" class="space-y-3"></div>

    <div class="grid grid-cols-1 gap-2">
      <button id="calc-week" class="btn-main">üìÖ T√≠nh l·ªãch tu·∫ßn</button>
      <button id="clear-week" class="btn-yellow">üßπ X√≥a tu·∫ßn n√†y</button>
      <button id="clear-all" class="btn-danger">üóë X√≥a t·∫•t c·∫£</button>
    </div>

    <div id="result-container" class="hidden">
      <div class="overflow-x-auto mt-3 rounded-lg border border-gray-200">
        <table class="w-full text-sm text-gray-700">
          <thead class="bg-blue-100">
            <tr>
              <th class="px-2 py-1 text-left">Th·ª©</th>
              <th class="px-2 py-1 text-left">Ca</th>
              <th class="px-2 py-1 text-center">Gi·ªù v√†o</th>
              <th class="px-2 py-1 text-center">Gi·ªù ra</th>
              <th class="px-2 py-1 text-center">T·ªïng</th>
            </tr>
          </thead>
          <tbody id="result-body"></tbody>
        </table>
      </div>
      <p id="tribute" class="text-center font-bold text-blue-600 mt-2 hidden">
        üí™ B·∫†N ƒê√É C·ªêNG HI·∫æN H·∫æT M√åNH C·∫¢ TU·∫¶N!
      </p>
    </div>

    <p class="text-center mt-3 font-semibold text-blue-600 text-sm bg-blue-50 py-2 rounded-lg shadow-sm">
      ‚ú® Created by H·∫£i 9 ‚ú®
    </p>

    <div class="border-t pt-4 mt-4">
      <h2 class="text-lg font-semibold text-blue-600 text-center mb-2">
        üîç Tra c·ª©u chuy·∫øn bay
      </h2>
      <p class="text-xs text-center text-red-500 mb-2 italic">
        "Link n√†y ch·ªâ c√≥ m·ª•c ƒë√≠ch tham kh·∫£o, File c√°n b·ªô g·ª≠i v·∫´n lu√¥n l√† chu·∫©n nh·∫•t"
      </p>
      <div class="space-y-2">
        <input id="search-name" type="text" placeholder="Nh·∫≠p t√™n nh√¢n vi√™n (VD: H·∫¢I 9 ho·∫∑c Hai 9)"
               class="w-full border border-gray-300 rounded-lg px-3 py-2 text-base focus:ring-2 focus:ring-blue-400"
               autocomplete="off">
        <div id="suggestions"
             class="bg-white border border-gray-200 rounded-lg shadow hidden max-h-40 overflow-y-auto"></div>
        <div id="flight-result" class="mt-3 text-sm"></div>
      </div>
    </div>
  </div>

  <div id="toast"></div>
<script>
/* ======== KH·ªûI T·∫†O INPUT CHO C√ÅC TH·ª® ======== */
document.addEventListener("DOMContentLoaded", () => {
  const days = ["Th·ª© Hai","Th·ª© Ba","Th·ª© T∆∞","Th·ª© NƒÉm","Th·ª© S√°u","Th·ª© B·∫£y","Ch·ªß Nh·∫≠t"];
  const box = document.getElementById("days-container");
  box.innerHTML = "";
  days.forEach((d,i)=>{
    const wrapper = document.createElement('div');
    wrapper.innerHTML = `
      <label class="block text-sm font-semibold text-gray-700 mb-1">${d}</label>
      <input id="day${i}" type="text" placeholder="VD: S; X; A; HC; 1X; X-1"
      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400">
    `;
    box.appendChild(wrapper);
  });
});
</script>

<script>
/* ================= JAVASCRIPT CH√çNH ================= */
const c = id => document.getElementById(id);
const days = ["Th·ª© Hai","Th·ª© Ba","Th·ª© T∆∞","Th·ª© NƒÉm","Th·ª© S√°u","Th·ª© B·∫£y","Ch·ªß Nh·∫≠t"];
const daysOrder = ["MON","TUE","WED","THU","FRI","SAT","SUN"];
const EXCEL_STORAGE_KEY = 'hgs_last_excel_data';
const SEARCH_STORAGE_KEY = 'hgs_last_search_name';

let employeeData = [];
let flightData = [];

const showToast = msg => {
  const t = document.createElement('div');
  t.className='toast';
  t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),2000);
};

/* --------- CHU·∫®N H√ìA CHU·ªñI ---------- */
function removeDiacritics(str){
  if(!str) return "";
  const s = str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  return s.replace(/ƒë/g,'d').replace(/ƒê/g,'D');
}
function normalizeText(s){
  if(!s) return "";
  return removeDiacritics(s)
    .replace(/[‚Äì‚Äî]/g,'-')
    .replace(/\u00A0/g,' ')
    .replace(/[^A-Z0-9\s\-]/gi,'')
    .trim()
    .replace(/\s+/g,' ')
    .toUpperCase();
}

/* ---------- L∆ØU TU·∫¶N, T·∫¢I TU·∫¶N ---------- */
function createInputs(){
  const box = c("days-container");
  box.innerHTML = "";
  days.forEach((d,i)=>{
    const wrapper = document.createElement('div');
    wrapper.innerHTML = `
      <label class="block text-sm font-semibold text-gray-700 mb-1">${d}</label>
      <input id="day${i}" type="text" placeholder="VD: S; X; A; HC; 1X; X-1"
      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-400">
    `;
    box.appendChild(wrapper);
  });
}
const keyWeek = n => "week_"+n;
const loadWeeksList = ()=>JSON.parse(localStorage.getItem("weeks_list")||"[]");
const saveWeeksList = arr=>localStorage.setItem("weeks_list", JSON.stringify(arr));

function saveWeek(){
  const n = c("week-name").value.trim();
  if(!n){ showToast("Nh·∫≠p t√™n tu·∫ßn"); return; }
  const data = {};
  days.forEach((_,i)=> data["day"+i]=c("day"+i).value.trim());
  localStorage.setItem(keyWeek(n), JSON.stringify(data));
  let list = loadWeeksList();
  if(!list.includes(n)){ list.push(n); saveWeeksList(list); fillWeekSelect(); }
  showToast("ƒê√£ l∆∞u tu·∫ßn "+n);
}
function fillWeekSelect(){
  const s = c("week-select"); if(!s) return;
  const list = loadWeeksList();
  s.innerHTML='<option value="">Ch·ªçn tu·∫ßn</option>';
  list.forEach(n=>{
    const o=document.createElement('option');
    o.value=n; o.textContent=n; s.appendChild(o);
  });
}
function loadWeek(n){
  const raw = localStorage.getItem(keyWeek(n));
  if(!raw){ showToast("Tu·∫ßn tr·ªëng"); return; }
  const d = JSON.parse(raw);
  days.forEach((_,i)=> c("day"+i).value = d["day"+i]||"");
  showToast("ƒê√£ t·∫£i "+n);
}
function deleteWeek(){
  const n=c("week-name").value.trim();
  if(!n) return showToast("Nh·∫≠p t√™n tu·∫ßn");
  localStorage.removeItem(keyWeek(n));
  let list = loadWeeksList().filter(x=>x!==n);
  saveWeeksList(list); fillWeekSelect();
  days.forEach((_,i)=> c("day"+i).value="");
  showToast("ƒê√£ x√≥a tu·∫ßn "+n);
}
function clearAll(){
  if(!confirm("X√≥a t·∫•t c·∫£ tu·∫ßn?")) return;
  loadWeeksList().forEach(n=>localStorage.removeItem(keyWeek(n)));
  saveWeeksList([]); fillWeekSelect();
  days.forEach((_,i)=> c("day"+i).value="");
  showToast("ƒê√£ x√≥a t·∫•t c·∫£");
}

/* ---------- T√çNH CA ---------- */
const shifts={HC:{start:7.5,end:15.5},A:{start:22,end:30},X:{start:14,end:22},S:{start:6,end:14}};
function parseShift(str){
  str=(str||"").toUpperCase().trim();
  if(!str) return null;
  const re=/^(\d*\.?\d*-?)?([A-Z]{1,2})(-?\d*\.?\d*)?$/;
  const m=re.exec(str);
  if(!m) return {error:"Sai ƒë·ªãnh d·∫°ng"};
  const [,pre,code,suf]=m;
  if(!shifts[code]) return {error:"Ca kh√¥ng t·ªìn t·∫°i"};
  let {start,end}=shifts[code];
  if(pre){ const val=parseFloat(pre.replace("-","")); pre.includes("-")?start+=val:start-=val; }
  if(suf){ const val=parseFloat(suf.replace("-","")); suf.startsWith("-")?end-=val:end+=val; }
  if(start>=end) end+=24;
  return {start,end,dur:end-start};
}
function fmtHoursToHHMM(t){
  const hh=Math.floor(t%24);
  const mm=Math.round((t%1)*60);
  return String(hh).padStart(2,"0")+":"+String(mm).padStart(2,"0");
}
function calcWeek(){
  const tbody=c("result-body"); if(!tbody) return;
  tbody.innerHTML=""; let total=0,full=true;
  days.forEach((d,i)=>{
    const v=c("day"+i).value.trim();
    if(!v){ tbody.innerHTML+=`<tr><td>${d}</td><td colspan=4 class="italic text-gray-400">Ngh·ªâ</td></tr>`; full=false; return; }
    let sum=0; const parts=v.split(";").map(x=>x.trim()).filter(Boolean);
    parts.forEach((p,j)=>{
      const r=parseShift(p);
      if(r&&r.error){tbody.innerHTML+=`<tr><td>${j?"":d}</td><td>${p}</td><td colspan=3 class="text-red-600">${r.error}</td></tr>`;return;}
      if(r){tbody.innerHTML+=`<tr><td>${j?"":d}</td><td>${p}</td><td>${fmtHoursToHHMM(r.start)}</td><td>${fmtHoursToHHMM(r.end)}</td><td>${r.dur.toFixed(1)}h</td></tr>`;sum+=r.dur;}
    });
    if(parts.length>1) tbody.innerHTML+=`<tr class="bg-blue-50 font-medium"><td></td><td colspan=3>T·ªïng ng√†y</td><td>${sum.toFixed(1)}h</td></tr>`;
    total+=sum;
  });
  tbody.innerHTML+=`<tr class="bg-blue-100 font-bold"><td colspan=4>T·ªïng tu·∫ßn</td><td>${total.toFixed(1)}h</td></tr>`;
  c("result-container").classList.remove("hidden");
  c("tribute").classList.toggle("hidden",!full);
  showToast("ƒê√£ t√≠nh xong!");
}

/* ---------- EXCEL PARSE ---------- */
function combine(a,b){
  const v1=(a||"").toString().trim();
  const v2=(b||"").toString().trim();
  let combined=[v1,v2].filter(Boolean).join(";");
  if(!combined||combined.toUpperCase().includes("OFF")) combined="";
  return combined;
}
function parseSheet(sheet,name){
  const rows=XLSX.utils.sheet_to_json(sheet,{header:1});
  if(rows.length<2) return [];
  return rows.slice(1).map(row=>({
    name:(row[1]||"").toString().trim(),
    mon:combine(row[2],row[4]),
    tue:combine(row[5],row[7]),
    wed:combine(row[8],row[10]),
    thu:combine(row[11],row[13]),
    fri:combine(row[14],row[16]),
    sat:combine(row[17],row[19]),
    sun:combine(row[20],row[22]),
    source:name
  })).filter(e=>e.name);
}

/* --- FIXED parseNameToken --- */
function parseNameToken(token){
  if(!token) return null;
  let raw=token.toString().trim()
    .replace(/\u00A0/g,' ')
    .replace(/[‚Äì‚Äî]/g,'-')
    .replace(/^[\s\-‚Äì‚Äî_]+|[\s\-‚Äì‚Äî_]+$/g,'')
    .replace(/\s+/g,' ')
    .trim();
  if(!raw) return null;
  const negativePattern=/\b(KO|K)\s*(BRD|BD)\b/i;
  const positivePattern=/\b(BRD|BD)\b/i;
  let tag="";
  if(negativePattern.test(raw)) tag="NO";
  else if(positivePattern.test(raw)) tag="BRD";
  const notes=[];
  if(/\bK[E√ä]M\s*QU·∫¶Y\b/i.test(raw)) notes.push("K√àM QU·∫¶Y");
  const nameNumPattern=/([\p{L}ƒêƒë\s\-]+?)\s+(\d{1,4})(?=\b|[;,\n\/]|$)/ug;
  const matches=[...raw.matchAll(nameNumPattern)];
  if(matches.length>0){
    return matches.map(m=>({
      nameOnly:`${m[1].trim()} ${m[2].trim()}`.toUpperCase(),
      tag,
      notes
    }));
  }
  return [{nameOnly:raw.toUpperCase(),tag,notes}];
}

/* --- Excel time --- */
function excelTimeToHHMM(v){
  if(v===undefined||v===null) return "";
  if(typeof v==='string') return v.trim();
  if(typeof v==='number'){
    const frac=v-Math.floor(v);
    const totalMinutes=Math.round(frac*24*60);
    const H=Math.floor(totalMinutes/60);
    const M=totalMinutes%60;
    return String(H).padStart(2,'0')+':'+String(M).padStart(2,'0');
  }
  return String(v);
}

/* --- parseFlightSheet (ƒë√£ fix regex & nhi·ªÅu t√™n) --- */
function parseFlightSheet(sheet,sheetName){
  const out=[];
  const startRow=4,endRow=200;
  const startCol=XLSX.utils.decode_col('V');
  const endCol=XLSX.utils.decode_col('AL');
  let lastFlt="",lastEtd="",lastGate="";
  for(let r=startRow;r<=endRow;r++){
    const fltCell=sheet['Q'+r];
    const etdCell=sheet['R'+r];
    const gateCell=sheet['G'+r];
    const fltValRaw=fltCell?(fltCell.v||'').toString().trim():'';
    const etdValRaw=etdCell?etdCell.v:'';
    const gateValRaw=gateCell?(gateCell.v||'').toString().trim():'';
    const fltVal=fltValRaw||lastFlt;
    const etdVal=etdValRaw!==undefined&&etdValRaw!==""?excelTimeToHHMM(etdValRaw):lastEtd;
    const gateVal=gateValRaw||lastGate;
    if(fltVal){lastFlt=fltVal;lastEtd=etdVal;lastGate=gateVal;}
    if(!fltVal) continue;
    for(let c=startCol;c<=endCol;c++){
      const colLetter=XLSX.utils.encode_col(c);
      const cell=sheet[colLetter+r];
      if(!cell||!cell.v) continue;
      let raw=String(cell.v).trim();
      if(!raw) continue;
      let parts=raw.split(/[,;\n|/]+/).map(x=>x.trim()).filter(Boolean);
      if(parts.length===1){
        const found=[...raw.matchAll(/[\p{L}ƒêƒë\-\s]+?\s*\d{1,4}\b/ug)].map(m=>m[0].trim());
        if(found.length>0) parts=found;
      }
      const isSup=colLetter==='V',isGate=colLetter==='W',
            isKetso=colLetter==='X',isWlct=colLetter==='Y';
      parts.forEach(sp=>{
        const parsedList=parseNameToken(sp);
        if(!parsedList||!parsedList.length) return;
        parsedList.forEach(parsed=>{
          const normalizedName=normalizeText(parsed.nameOnly);
          out.push({
            sheet:sheetName,row:r,col:colLetter,tokenRaw:sp,
            nameOnly:parsed.nameOnly,nameNormalized:normalizedName,
            tag:parsed.tag,notes:parsed.notes||[],
            flt:fltVal,etd:etdVal,gate:gateVal,
            supFlag:isSup,gateFlag:isGate,ketsoFlag:isKetso,wlctFlag:isWlct,
            uniqueKey:`${sheetName}-${fltVal}-${etdVal}-${gateVal}-${normalizedName}-${colLetter}-${r}`
          });
        });
      });
    }
  }
  return out;
}

/* --- ƒê·ªçc file Excel & g·ªôp d·ªØ li·ªáu --- */
function processExcelData(data){
  const wb=XLSX.read(data,{type:"array"});
  const target=["b·∫£ng ch·∫•m c√¥ng qt","b·∫£ng ch·∫•m c√¥ng nƒë"];
  let allEmp=[];
  target.forEach(t=>{
    const sn=wb.SheetNames.find(n=>n.trim().toLowerCase()===t);
    if(sn){const s=wb.Sheets[sn];allEmp=allEmp.concat(parseSheet(s,sn));}
  });
  employeeData=allEmp;
  const sel=c("employee-select");
  sel.innerHTML='<option value="">-- Ch·ªçn nh√¢n vi√™n --</option>';
  employeeData.sort((a,b)=>a.name.localeCompare(b.name,"vi",{sensitivity:"base"}))
    .forEach(e=>{
      const o=document.createElement('option');
      o.value=e.name;o.textContent=e.name+" ("+e.source.toUpperCase().replace("B·∫¢NG CH·∫§M C√îNG ","")+")";
      sel.appendChild(o);
    });
  flightData=[];
  daysOrder.forEach(d=>{
    const sn=wb.SheetNames.find(n=>n.trim().toUpperCase()===d);
    if(sn){const s=wb.Sheets[sn];flightData=flightData.concat(parseFlightSheet(s,d));}
  });
  return true;
}

/* --- File Upload --- */
c("excel-upload").addEventListener("change",e=>{
  const f=e.target.files[0];if(!f) return;
  const r=new FileReader();
  r.onload=evt=>{
    const data=new Uint8Array(evt.target.result);
    const binary=data.reduce((a,i)=>a+String.fromCharCode(i),"");
    const base64=btoa(binary);
    localStorage.setItem(EXCEL_STORAGE_KEY,base64);
    processExcelData(data);
    showToast("‚úÖ ƒê√£ t·∫£i file Excel");
  };
  r.readAsArrayBuffer(f);
});

/* --- T·∫£i l·∫°i file l∆∞u --- */
function loadLastExcelData(){
  const base64=localStorage.getItem(EXCEL_STORAGE_KEY);
  if(!base64) return false;
  try{
    const binary=atob(base64);
    const arr=new Uint8Array(binary.length);
    for(let i=0;i<binary.length;i++) arr[i]=binary.charCodeAt(i);
    processExcelData(arr);
    showToast("ƒê√£ t·∫£i d·ªØ li·ªáu t·ª´ b·ªô nh·ªõ");
    return true;
  }catch(e){console.error(e);localStorage.removeItem(EXCEL_STORAGE_KEY);return false;}
}

/* --- employee-select --- */
c("employee-select").addEventListener("change",e=>{
  const name=e.target.value;if(!name) return;
  const emp=employeeData.find(x=>x.name.trim().toLowerCase()===name.trim().toLowerCase());
  if(!emp) return showToast("Kh√¥ng t√¨m th·∫•y!");
  ["mon","tue","wed","thu","fri","sat","sun"].forEach((d,i)=>c("day"+i).value=emp[d]||"");
  showToast("ƒê√£ t·∫£i l·ªãch c·ªßa "+name);
});

/* --- SEARCH --- */
function renderSuggestions(q){
  const box=c("suggestions");
  if(!q||!flightData.length){box.classList.add("hidden");return;}
  const qNorm=normalizeText(q);
  const map=new Map();
  flightData.forEach(d=>{if(d.nameNormalized&&!map.has(d.nameNormalized))map.set(d.nameNormalized,d.nameOnly);});
  const matches=[...map.entries()].filter(([norm])=>norm.includes(qNorm))
    .map(([norm,disp])=>({norm,disp}));
  if(!matches.length){box.classList.add("hidden");return;}
  box.innerHTML=matches.map(m=>`<div class="px-3 py-2 hover:bg-blue-50 cursor-pointer" data-n="${m.norm}">${m.disp}</div>`).join("");
  box.classList.remove("hidden");
  box.querySelectorAll("div").forEach(div=>{
    div.onclick=()=>{
      const val=div.textContent;
      c("search-name").value=val;
      box.classList.add("hidden");
      renderFlightResults(val);
    };
  });
}
function nameMatches(searchNorm, tokenNorm){
  if(!searchNorm||!tokenNorm) return false;
  return tokenNorm===searchNorm || tokenNorm.includes(searchNorm);
}
function renderFlightResults(nameRaw){
  const container=c("flight-result");
  if(!flightData.length){
    container.innerHTML=`<p class="text-center text-gray-500 italic">Ch∆∞a c√≥ d·ªØ li·ªáu. H√£y t·∫£i file Excel.</p>`;return;
  }
  const qNorm=normalizeText(nameRaw);
  let matches=flightData.filter(d=>nameMatches(qNorm,d.nameNormalized));
  if(!matches.length){container.innerHTML=`<p class="text-center text-gray-500 italic">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho "${nameRaw}"</p>`;return;}
  const unique=new Map();
  matches.forEach(m=>{
    const key=`${m.sheet}-${m.flt}-${m.etd}-${m.gate}-${m.nameNormalized}`;
    if(unique.has(key)){
      const e=unique.get(key);
      e.supFlag|=m.supFlag;e.gateFlag|=m.gateFlag;e.ketsoFlag|=m.ketsoFlag;e.wlctFlag|=m.wlctFlag;
    }else unique.set(key,{...m});
  });
  matches=[...unique.values()];
  const grouped={};daysOrder.forEach(d=>grouped[d]=[]);
  matches.forEach(m=>grouped[m.sheet].push(m));
  const now=new Date();
  const vnWeekday=new Intl.DateTimeFormat('vi-VN',{timeZone:'Asia/Bangkok',weekday:'long'}).format(now).toLowerCase();
  const mapVN={'th·ª© hai':0,'th·ª© ba':1,'th·ª© t∆∞':2,'th·ª© nƒÉm':3,'th·ª© s√°u':4,'th·ª© b·∫£y':5,'ch·ªß nh·∫≠t':6};
  const todayIndex=mapVN[vnWeekday]??new Date().getDay()-1;

  let html="";
  daysOrder.forEach((day,idx)=>{
    const rows=grouped[day];
    const isPast=idx<todayIndex, isToday=idx===todayIndex;
    html+=`<div class="day-container ${isPast?'day-past':''} ${isToday?'day-today':''}">
      <div class="day-title">${day}</div>`;
    if(!rows.length){
      html+=`<p class="text-gray-400 italic">Kh√¥ng c√≥ d·ªØ li·ªáu</p>`;
    } else {
      html+=`<table class="w-full result-table mt-1"><thead><tr>
        <th>FLT</th><th>ETD</th><th>SUP</th><th>GATE</th><th>K·∫øt s·ªï</th><th>WLC</th><th>Boarding</th></tr></thead><tbody>`;
      rows.forEach(r=>{
        let brd=r.tag==="BRD"?"‚úÖ":r.tag==="NO"?"‚ùå":"";
        html+=`<tr>
          <td>${r.flt||'‚Äî'}</td>
          <td>${r.etd||'‚Äî'}</td>
          <td class="center">${r.supFlag?'‚úÖ':''}</td>
          <td class="center">${r.gateFlag?'‚úÖ':''}</td>
          <td class="center">${r.ketsoFlag?'‚úÖ':''}</td>
          <td class="center">${r.wlctFlag?'‚úÖ':''}</td>
          <td class="center">${brd}</td>
        </tr>`;
      });
      html+=`</tbody></table>`;
    }
    html+=`</div>`;
  });
  container.innerHTML=html;
}

/* --- Wire events --- */
c("search-name").addEventListener("input",e=>renderSuggestions(e.target.value||""));
c("search-name").addEventListener("keydown",e=>{
  if(e.key==="Enter"){e.preventDefault();renderFlightResults(e.target.value);}
});

document.addEventListener("DOMContentLoaded",()=>{
  createInputs();fillWeekSelect();loadLastExcelData();
  const last=localStorage.getItem(SEARCH_STORAGE_KEY);
  if(last){c("search-name").value=last;setTimeout(()=>renderFlightResults(last),500);}
  c("save-week").onclick=saveWeek;
  c("week-select").onchange=e=>{const v=e.target.value;if(v){c("week-name").value=v;loadWeek(v);} };
  c("calc-week").onclick=calcWeek;
  c("clear-week").onclick=deleteWeek;
  c("clear-all").onclick=clearAll;
});
</script>

</body>
</html>
